<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" href="./favicon.ico" />
    <title>轨迹回放</title>
    <link rel="stylesheet" href="dist/styles/iview.css">
    <style>
        html,
        body,
        #container,
        #bmap {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        div.controller {
            position: absolute;
            right: 10px;
            bottom: 10px;
            line-height: 60px;
        }

        div.close-icon{
            position: absolute;
            top: -50px;
            right: 0;
            width: 32px;
            height: 32px;
        }

        div.right-button-wrap{
            position: absolute;
            right: 10px;
            top: 10px;
            width: 80px;
            height: 35px;
            cursor: pointer;
        }
        div.right-button-wrap img,.right-button-wrap-marker img{
            width: 100%;
            height: 100%;
            border: 0;
        }
        .right-button-wrap-marker{
            position: absolute;
            right: 10px;
            top: 70px;
            width: 80px;
            height: 35px;
            cursor: pointer;
        }
        div.right-button-wrap-ceju{
            position: absolute;
            right: 10px;
            top: 135px;
            width: 80px;
            height: 35px;
            padding: 0 5px;
        }
        div.btn-label{
            position: absolute;
            left: 50%;
            bottom: -15px;
            transform: translateX(-50%);
            background: #FB6726;
            color: #fff;
            font-size: 12px;
            text-align: center;
            width: 50px;
        }
        label.BMapLabel::after {
            font-size: 0px;
            line-height: 0px;
            width: 0px;
            height: 0px;
            border-width: 10px;
            border-style: dashed solid dashed dashed;
            border-color: transparent red transparent transparent;
            position: absolute;
            margin-left: -19px;
            margin-top: -42px;
        }

        .guiji_sanjiao {
            font-size: 0px;
            line-height: 0px;
            width: 0px;
            height: 0px;
            border-width: 10px;
            border-style: dashed solid dashed dashed;
            border-color: transparent #666 transparent transparent;
            position: absolute;
            margin-left: -30px;
            margin-top: -76px;
        }

        .guiji_sanjiao_2 {
            font-size: 0px;
            line-height: 0px;
            width: 0px;
            height: 0px;
            border-width: 10px;
            border-style: dashed solid dashed dashed;
            border-color: transparent #F7F8F9 transparent transparent;
            position: absolute;
            margin-left: -30px;
            margin-top: -76px;
        }

        p.last-address{
            white-space:normal;
            width:296px;
            height: 36px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
            overflow: hidden;
        }
        .fade-enter-active, .fade-leave-active {
            transition: all .3s;
        }
        .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
            opacity: 0;
            transform: translateY(300px);
        }
        [v-cloak]{
            display: none;
        }
    </style>
    <script src="js/js.cookie.min.js"></script>
    <script src="js/distancetool_min.js"></script>
    <script>
        var token = Cookies.get("token");
    </script>
</head>

<body>
    <div id="container" v-cloak>
        <div id="bmap"></div>
        <div class="right-button-wrap" @click="changePosiType">
            <img v-if="isExtract" src="./images/ic_fine_network_off.png">
            <img v-else src="./images/ic_fine_network_on.png">
            <div class="btn-label">{{isZh ? '精 / 粗' : 'Fine / Coarse'}} </div>
        </div>
        <div class="right-button-wrap-marker" @click="onShowMarker">
            <img v-if="isShowMarker" src="./images/ic_on.png">
            <img v-else src="./images/ic_off.png">
            <div class="btn-label">  {{isZh ? '显示点' : 'Marker'}}</div>
        </div>
        <div class="right-button-wrap-ceju">
            <i-button @click="openDistance" size="small" style="width:100%;">{{isZh ? '测距' : 'Ranging'}}</i-button>
        </div>
        <div class="controller">
            <div class="close-icon" @click="onShowCtrl">
                <i-button shape="circle" icon="ios-arrow-down" v-if="isShowCtrl"></i-button>
                <i-button shape="circle" icon="ios-arrow-up" v-else></i-button>
            </div>
            <transition name="fade">
                    <div style="width: 500px;height: 300px;background: #E8F0F7;border: 1px solid #C3CEDE;" v-show="isShowCtrl">
                            <Row>
                                <i-col :span="4" style="text-align: center;height:45px;">{{$t("main.selectDate")}} : &nbsp;</i-col>
                                <i-col :span="11" style="height:45px;">
                                    <date-picker type="date" style="width: 100%;height:45px;" v-model="startTime"  :clearable="false" :editable="false"></date-picker>
                                </i-col>
                                <i-col :span="4" style="text-align: center;height:45px;">
                                    <i-button @click="prevDay">{{$t("main.prevDay")}}</i-button>
                                </i-col>
                                <i-col :span="4" style="text-align: center;height:45px;">
                                    <i-button @click="nextDay">{{$t("main.nextDay")}}</i-button>
                                </i-col>
                            </Row>
                
                            <Row>
                                <i-col :span="9" style="text-align: center;height:45px;">{{$t("main.startDate")}} : {{startTimeStr}} </i-col>
                                <i-col :span="9" style="text-align: center;height:45px;">{{$t("main.endDate")}} : {{endTimeStr}} </i-col>
                                <i-col :span="5" style="text-align: center;height:45px;">
                                    <i-button @click="sosoTracks">{{$t("main.queryBtn")}}</i-button>
                                </i-col>
                                <i-col :span="1" style="height:45px;">&nbsp;</i-col>
                            </Row>
                
                    
                            <Row> 
                                    <i-col :span="4" style="line-height:60px;text-align:center;"> {{$t("main.playSpeed")}} : &nbsp;</i-col>
                                    <i-col :span="18" style="height:60px; padding-top: 12px;">
                                        <Slider v-model="velocity" :min="100" :max="5000" show-input :step="100"></Slider>
                                    </i-col>
                                    <i-col :span="2" style="line-height:60px;text-align:center;"> {{$t("main.msec")}} </i-col>
                            </Row>
                            <Row>
                                <i-col :span="21" style="padding:0 10px;height:35px;line-height: 35px;">
                                    {{(isZh ? '总里程数' : 'Mileage')}} : {{totalMileage}}
                                </i-col>
                            </Row>
                
                            <Row>
                                <i-col :span="6" :offset="3" style="padding:0 5px;height:45px;">
                                    <i-button style="width: 100%" @click="beginPlay">{{$t("main.play")}}</i-button>
                                </i-col>
                                <i-col :span="6" style="padding:0 5px;height:45px;">
                                    <i-button style="width: 100%" @click="pause">{{$t("main.pause")}}</i-button>
                                </i-col>
                                <i-col :span="6" style="padding:0 5px;height:45px;">
                                    <i-button style="width: 100%" @click="replay">{{$t("main.replay")}}</i-button> 
                                </i-col>
                            </Row>
                            <Row>
                                    <i-col :span="6" :offset="3" style="padding:0 5px;height:45px;">
                                        <i-button style="width: 100%" @click="prevStep">{{$t("main.prevStep")}}</i-button>
                                    </i-col>
                                    <i-col :span="6" style="padding:0 5px;height:45px;">
                                        <i-button style="width: 100%" @click="pause">
                                            {{ isExtract ? (extractRecords.length == 0 ? 0 : index + 1) :  (records.length == 0 ? 0 : index + 1)}} 
                                            / 
                                            {{ isExtract ? extractRecords.length : records.length }}
                                        </i-button>
                                    </i-col>
                                    <i-col :span="6" style="padding:0 5px;height:45px;">
                                        <i-button style="width: 100%" @click="nextStep">{{$t("main.nextStep")}}</i-button>
                                    </i-col>
                            </Row>
                    </div>
            </transition>
        </div>
        <Modal v-model="modal" width="600">
            <p slot="header" style="color:#2D8CF0;text-align:center">
                <Icon type="ios-hammer-outline"></Icon>
                <span>{{$t("main.posiDetail")}}</span>
            </p>
            <div style="">
               <p style="margin: 10px">{{$t("main.trackId")}} : {{trackid}}</p>
               <p style="margin: 10px">{{$t("main.jizhanList")}} : {{xList}}</p>
               <p style="margin: 10px">{{$t("main.WIFIList")}} : {{wList}}</p>
               <p style="margin: 10px;word-wrap:break-word;">{{$t("main.originalData")}} : {{trackStringify}}</p>
            </div>
        </Modal>
        <Modal v-model="modal1" width="600">
            <p slot="header" style="color:#2D8CF0;text-align:center">
                <Icon type="ios-hammer-outline"></Icon>
                <span>{{$t("main.result")}}</span>
            </p>
            <div style="text-align: center;">
                <p>
                    {{cause}}
                </p>
            </div>
        </Modal>
        <Spin size="large" fix v-if="spinShow"></Spin>
    </div>
    <script src="dist/vue.min.js"></script>
    <script src="dist/iview.min.js"></script>
    <script src="./js/jquery.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/vue-i18n.min.js"></script>
    <script src="./js/hashmap.js"></script>
    <script src="./js/localcachemgr.js"></script>
    <script src="./js/transformlatlon.js"></script>
    <script src="./js/dateformat.js"></script>
    <script src="./js/util.js"></script>
    <script src="./js/js.cookie.min.js"></script>
    <script src="./js/en-US.js"></script>
    <script src="./js/zh-CN.js"></script>
    <script src="http://api.map.baidu.com/api?v=3.0&ak=e7SC5rvmn2FsRNE4R1ygg44n"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/DistanceTool/1.2/src/DistanceTool_min.js"></script>
    <script>
        Vue.use(iview);
        Vue.use(VueI18n);
        var isZh = utils.locale === 'zh'; 
        document.title = isZh ? "轨迹回放" : "Playback";
        iview.lang(isZh ? 'zh-CN' : 'en-US');
        var currentTrack = null;
        var vm = null;
        function queryTrackDetail(deviceid){
            var data = {
                deviceid:deviceid,
                updatetime:currentTrack.updatetime,
                trackid:currentTrack.trackid
            };
            var url = myUrls.queryTrackDetail();
            utils.sendAjax(url,data,function (resp) { 
                if(resp.status == 0 ){
                    vm.xList = resp.track.x ? resp.track.x : isZh?'空':'Empty';
                    vm.wList = resp.track.w ? resp.track.w : isZh?'空':'Empty';
                    vm.trackid = resp.track.trackid;
                    vm.trackStringify = JSON.stringify(resp);
                    vm.modal = true;
                }else{
                    vm.$Message.error("error");
                }
            });
        };

        function refreshTrackPosition(deviceid) { 
            var trackid = currentTrack.trackid;
            var data = {
                deviceid:deviceid,
                updatetime:currentTrack.updatetime,
                trackid:currentTrack.trackid
            };
            var url = myUrls.refreshTrackPosition();
            utils.sendAjax(url,data,function (resp) { 
                if(resp.status === 0){
                    vm.$Message.success(isZh?"刷新成功":"Refresh success");
                    Cookies.set(deviceid + '-' + trackid , true);
                }else{
                    vm.modal1 = true;
                    vm.cause = resp.cause;
                }
                //Cookies.set(deviceid + '-' + trackid , true);
            });
        };
        var messages = {
            en: {
                main:{
                    selectDate:"Select Date",
                    prevDay:"Prev Day",
                    nextDay:"Next Day",
                    startDate:"Start time",
                    endDate:"End time",
                    queryBtn:"Query",
                    playSpeed:"Play Speed",
                    msec:"ms",
                    play:"Play",
                    pause:"Pause",
                    replay:"Replay",
                    prevStep:"Prev step",
                    nextStep:"Next step",
                    empty:"Empty",
                    refreshSuccess:"Refresh success",
                    posiDetail:"Positon details",
                    trackId:"Track ID",
                    jizhanList:"Base station",
                    WIFIList:"WiFi",
                    originalData:"Original Data",
                    result:"Position result"
                }

            },
            zh: {
                main:{
                    selectDate:"选择时间",
                    prevDay:"上一天",
                    nextDay:"下一天",
                    startDate:"开始时间",
                    endDate:"结束时间",
                    queryBtn:"查询轨迹",
                    playSpeed:"播放速度",
                    msec:"毫秒",
                    play:"播放",
                    pause:"暂停",
                    replay:"重播",
                    prevStep:"上一步",
                    nextStep:"下一步",
                    empty:"空",
                    refreshSuccess:"刷新成功",
                    posiDetail:"定位详情",
                    trackId:"轨迹序号",
                    jizhanList:"基站列表",
                    WIFIList:"WiFi列表",
                    originalData:"原始数据",
                    result:"定位结果"
                }
            }
        };
        (function () {   //utils.getAngle
            var carIcon = new BMap.Icon("images/carstate/green_0.gif", new BMap.Size(17, 17), { imageOffset: new BMap.Size(0, 0) });
            var startIcon = new BMap.Icon("./images/map/marker_qidian.png", new BMap.Size(32, 32), { imageOffset: new BMap.Size(0, 0) });
            var endIcon = new BMap.Icon("./images/map/marker_zhongdian.png", new BMap.Size(32, 32), { imageOffset: new BMap.Size(0, 0) });
            
                vm = new Vue({
                el: "#container",
                i18n: utils.getI18n(),
                data: {
                    isZh : isZh ,
                    isShowCtrl:true,
                    isShowMarker:false,
                    map: null,
                    myDis:null,
                    totalMileage:'0km',
                    selectDate: null,
                    dayTime: 60 * 60 * 24 * 1000,
                    lock: false,
                    deviceid: null,
                    startTime: null,
                    startTimeStr: "",
                    endTimeStr: "",
                    len: null,
                    spinShow: false,
                    isExtract:false,
                    records: [],
                    extractRecords:[],//精确位置
                    markers:[],
                    range: 1,             // 范围1米之内的点不显示
                    velocity: 1000,         // 半秒
                    intervalInstanse: null,
                    carMarker: null,
                    markerLabel: null,
                    index: 0,
                    isPlay: true,
                    firstMarker: null,
                    lastMakrker: null,
                    polyline: null,
                    modal:false,
                    modal1:false,
                    cause:"",
                    xList:'',
                    wList:'',
                    trackid:'',
                    trackStringify:""
                },
                methods: {
                    initMap: function () {
                        this.map = new BMap.Map("bmap", { minZoom: 4, maxZoom: 18 ,enableMapClick: false });
                        this.map.enableScrollWheelZoom();
                        this.map.enableAutoResize();
                        this.map.disableDoubleClickZoom();
                        var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});
                        var top_left_navigation = new BMap.NavigationControl(); //左上角，添加默认缩放平移控件
                        this.map.addControl(top_left_control);
                        this.map.addControl(top_left_navigation);
                        this.map.centerAndZoom(new BMap.Point(108.0017245, 35.926895), 5);

                    },
                    openDistance: function () {
                        if (this.myDis != null) {
                            this.myDis.close();
                        };
                        this.myDis = new BMapLib.DistanceTool(this.map);
                        this.myDis.open();
                    },
                    changeVelocity: function (value) {
                        this.velocity = value;
                    },
                    changePosiType:function(){
                        clearInterval(this.intervalInstanse);
                        this.isExtract = !this.isExtract;
                        this.resetMapState();
                        this.drawingLine();
                    },
                    nextDay:function(){
                        this.startTime = new Date(this.startTime.getTime() + this.dayTime);
                    },
                    prevDay:function(){
                        this.startTime = new Date(this.startTime.getTime()  - this.dayTime);
                    },
                    prevStep:function(){
                        if (this.intervalInstanse != null) {
                            clearInterval(this.intervalInstanse);
                        };
                        this.index--;
                        if(this.isExtract){
                            if(this.index < 0 ){
                                this.index = this.extractRecords.length - 1;
                            }
                            var track = this.extractRecords[this.index];
                        }else{
                            if(this.index < 0 ){
                                this.index = this.records.length - 1;
                            }
                            var track = this.records[this.index];
                        }
                  
                        var marker = this.getPointMarker();
                        this.openInfoWindow(marker,track);
                    },
                    nextStep:function(){
                        if (this.intervalInstanse != null) {
                            clearInterval(this.intervalInstanse);
                        };
                        this.index++;
                        if(this.isExtract){
                             if(this.index > this.extractRecords.length-1){
                                this.index = 0;
                            }
                            var track = this.extractRecords[this.index];
                        }else{
                           if(this.index > this.records.length-1){
                                this.index = 0;
                            }
                            var track = this.records[this.index];
                        }
                        var marker = this.getPointMarker();
                        this.openInfoWindow(marker,track);
                    },
                    getPointMarker:function(){
                        var index = this.index;
                        var marker = null;
                        if(!this.isShowMarker){
                            return this.carMarker;
                        };
                        for(var i = 0 ;  i < this.markers.length ; i ++){

                            marker = this.markers[i];
                            if(marker.index == index){
                                return marker;
                            }
                        }
                    },
                    sosoTracks: function () {
                        var me = this;
                        me.resetMapState();

                        me.requestTracks(this.startTimeStr, this.endTimeStr, function (resp) {
                            var records = resp.records;
                            me.spinShow = false;
                            if (resp.status == 0 && records) { 
                                records.sort(function (a, b) {
                                    return a.updatetime - b.updatetime;
                                });
                                me.filtertracks(records);
                                me.drawingLine();
                            }else  if (resp.status == 3 ) {
                                me.totalMileage = '0km';
                                me.$Message.error(resp.cause);
                            }else{
                                me.totalMileage = '0km';
                                me.$Message.error("没有当天轨迹");
                            } 
                        });

                    },
                    requestTracks: function (beginTime, endtime, callback) {
                        this.spinShow = true;
                        var me = this;
                        var url = myUrls.queryTracks();
                        var data = {
                            deviceid: this.deviceid,
                            lbs: 1,
                            timeorder: 0,
                            begintime: beginTime,
                            endtime: endtime
                        };
                        utils.sendAjax(url, data, function (resp) {
                            callback(resp)
                        });
                    },
                    filtertracks: function (records) {
                        var extractRecords = [];
                        var newRecords = [];
                        for (var i = 0; i < records.length; i++) {
                            var track = records[i];
                            var direction = utils.getAngle(track.course);
                            var lng_lat = wgs84tobd09(track.callon, track.callat);
                            track.direction = direction;
                            track.point = new BMap.Point(lng_lat[0], lng_lat[1]);
                            newRecords.push(track);
                            if(track.gotsrc == "gps"){
                                extractRecords.push(track);
                            }
                        };
                        this.records = newRecords;
                        this.extractRecords = extractRecords;
                    },
                    drawingLine: function () {
                        var records = this.getTypeRecords();
                     
                        // var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
                        //             scale: 0.6,//图标缩放大小
                        //             strokeColor:'#fff',//设置矢量图标的线填充颜色
                        //             strokeWeight: '2',//设置线宽
                        //         });
                          
                        // var lineIcon = new BMap.IconSequence(sy, '10', '30'); 
                        var lines;
                        if (records.length > 1) {
             
                            var firstRecord = records[0];
                            var lastRecord = records[records.length - 1];
                            this.firstMarker = new BMap.Marker(firstRecord.point, { icon: startIcon });
                            this.lastMakrker = new BMap.Marker(lastRecord.point, { icon: endIcon });
                            this.firstMarker.index = 0;
                            this.lastMakrker.index = records.length-1;
                       
                            this.map.addOverlay(this.firstMarker);
                            this.map.addOverlay(this.lastMakrker);
                            this.addEventListenerToMarker(this.firstMarker);
                            this.addEventListenerToMarker(this.lastMakrker);

                            lines = [];
                               

                            for (var i = 0; i < records.length; i++) {
                                var point = records[i].point;
                                lines.push(point);

                                if(i !=0 && i != records.length-1){
                                    var makrker = new BMap.Marker(point);
                                    makrker.index = i;
                                    this.isShowMarker && this.map.addOverlay(makrker);
                                    this.addEventListenerToMarker(makrker);
                                    this.markers.push(makrker);
                                }
                            };
                            this.markers.unshift(this.firstMarker);
                            this.markers.push(this.lastMakrker);

                            // this.polyline = new BMap.Polyline(lines, { strokeColor: "#e4393c", strokeWeight: 8, strokeOpacity: 1.5 ,icons:[icons]});
                           
                            this.polyline = new BMap.Polyline(lines, { 
                                enableEditing: false,//是否启用线编辑，默认为false
                                enableClicking: true,//是否响应点击事件，默认为true
                                enableMassClear:true,
                                // icons:[lineIcon],
                                strokeWeight:'8',//折线的宽度，以像素为单位
                                strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
                                strokeColor:"#F41C2E" //折线颜色
                            });
                 
                            this.map.addOverlay(this.polyline);
                            // 设置中心点
                            this.getTotalMileage(records);
                            this.setViewPortCenter(lines);
                            this.runAnimeate(records);

                        }else if(records.length == 1){
                                var lastRecord = records[records.length - 1];
                                this.totalMileage = '0km';
                                this.firstMarker = new BMap.Marker(lastRecord.point, { icon: endIcon });
                                
                                this.map.addOverlay(this.firstMarker);
                                lines = [];

                                for (var i = 0; i < records.length; i++) {
                                    lines.push(records[i].point);
                                };
                  
                                 // 设置中心点
                                this.setViewPortCenter(lines);
                                this.runAnimeate(records);
                        };
                        
                    },
                    getTotalMileage:function(records){
                        var totaldistance = records[records.length-1].totaldistance - records[0].totaldistance;
                        this.totalMileage = utils.getMileage(totaldistance);
                    },
                    addEventListenerToMarker:function(marker){
                        var me = this;
                        marker.addEventListener("click",function () { 
                            var index = marker.index;
                            var track = (function () { 
                                var track = null;
                                if(me.isExtract){
                                    track = me.extractRecords[index];
                                }else{
                                    track = me.records[index];
                                }
                                return track;
                            })();

                            me.index = index;
                            me.openInfoWindow(marker,track);
                        });
                    },
                    openInfoWindow:function(marker,track){
                        var sContent = this.getLableContent(track);
                        var windowInfo = new BMap.InfoWindow(sContent);
                            windowInfo.disableCloseOnClick();
                            marker.openInfoWindow(windowInfo);
                            this.carMarker.setPosition(track.point);
                            this.carMarker.setIcon(this.getDirectionIcon(track.direction));
                    },
                    setViewPortCenter: function (lines) {
                        var view = this.map.getViewport(eval(lines));
                        var mapZoom = view.zoom;
                        var centerPoint = view.center;
                        this.map.centerAndZoom(centerPoint, mapZoom);
                    },
                    runAnimeate: function (records) {
                        var firstRecord = records[0];
                        var lableOptions = {
                            position: firstRecord.point,
                            offset: new BMap.Size(30, -60)
                        };
                        this.carMarker = new BMap.Marker(firstRecord.point, { icon: carIcon });
                        this.map.addOverlay(this.carMarker);
                        this.openInfoWindow(this.firstMarker,firstRecord);
                    },
                    getTypeRecords:function(){
                        var records = null;
                        if(this.isExtract){
                            records = this.extractRecords;
                        }else{
                            records = this.records;
                        };

                        return records;
                    },
                    action: function () {
                        var me = this;
                        var records = this.getTypeRecords();
                        if(records.length){
                            var paths = records.length;
                            if (me.intervalInstanse != null) {
                                clearInterval(me.intervalInstanse);
                            };
                            me.intervalInstanse = setInterval(function () {
                                me.index++;
                                if (me.index >= paths) {
                                    clearInterval(me.intervalInstanse);
                                    me.index = 0;
                                    me.openInfoWindow(me.firstMarker,records[me.index]);
                                };
                                var track = records[me.index];
                                me.carMarker.setPosition(track.point);
                                me.carMarker.setIcon(me.getDirectionIcon(track.direction));
                                // me.markerLabel.setContent(me.getLableContent(track));
                                var sContent = me.getLableContent(track);
                                var windowInfo = new BMap.InfoWindow(sContent);
                                me.carMarker.openInfoWindow(windowInfo);

                            }, me.velocity);
                        };
                    },
                    replay: function () {
                        this.index = 0;
                        var records = this.getTypeRecords();   
                        if (!this.isPlay) {
                            this.isPlay = true;
                        }
                        if (records.length < 2) { return; }
                        this.action();
                    },
                    beginPlay: function () {
                        var records = this.getTypeRecords();
                        if (records.length < 2) { return; }
                        this.isPlay = true;
                        this.action();
                    },
                    pause: function () {
                        this.isPlay = false;
                        clearInterval(this.intervalInstanse);
                    },
                    getLableContent: function (info) {
                        currentTrack = info;
                        var address = this.getAddress(info);
                        var posiType = utils.getPosiType(info);
                        var color = '#515A6E';
                        var strstatus = null;
                        if (info.radius > 0) {
                            var radiuDesc = null;
                            if (isZh) {
                                radiuDesc = ' (误差范围:' + info.radius + '米)';
                            } else {
                                radiuDesc = ' (Error range:' + info.radius + 'm)';
                            }
                            posiType += radiuDesc;
                        };
                        if (isZh) {
                            strstatus = info.strstatus ? info.strstatus : '';
                        } else {
                            strstatus = info.strstatusen ? info.strstatusen : '';
                        }
                        if(Cookies.get(this.deviceid+'-'+info.trackid)){
                            color = 'red';
                        };
                        var speed = info.speed == 0 ? "0km/h" : (info.speed / 1000).toFixed(2) + "km/h";
                        var sContent = '<div style="max-width:296px;">' +
                            '<p> ' + (isZh ? '设备名称' : 'Device Name') + ': ' + this.deviceid + '</p>' +
                            '<p> ' + (isZh ? '经纬度' : 'Longitude and latitude') + ': ' + info.callon.toFixed(6) + "," + info.callat.toFixed(6)  + '</p>' +
                            '<p> ' + (isZh ? '定位类型' : 'Position Type') + ': ' + posiType  + '</p>' +
                            '<p> ' + (isZh ? '方向' : 'Direction') + ': ' + utils.getCarDirection(info.course)+ '</p>' +
                            '<p> ' + (isZh ? '速度' : 'Speed') + ': ' + speed +'('+(isZh ? '信号:' : 'Signal:')+ info.rxlevel+'%)</p>' +
                            '<p> ' + (isZh ? '总里程' : 'Mileage') + ': ' + utils.getMileage(info.totaldistance) + '</p>' +
                            '<p> ' + (isZh ? '最后时间' : 'Last time') + ': ' + DateFormat.longToDateTimeStr(info.updatetime, 0) + '</p>' +
                            '<p> ' + (isZh ? '状态' : 'Status') + ': ' + strstatus + '</p>' +
                            '<p class="last-address"> ' + (isZh ? '详细地址' : 'Address') + ': ' + address + '</p>'+
                            '<p>'+
                                '<span style="margin-right:5px;" class="ivu-btn ivu-btn-default ivu-btn-small" onclick="queryTrackDetail(' + this.deviceid +')">' + (isZh ? '详细信息' : 'Detailed info') + '</span>'+
                                '<span class="ivu-btn ivu-btn-default ivu-btn-small" onclick="refreshTrackPosition(' +this.deviceid +')" style="color:'+color+';">' + (isZh ? '刷新位置' : 'Refresh position') + '</span>'+
                            '</p>'+
                            '</div>';
                        return sContent;
                    },
                    getAddress: function (info) {
                        var callon = info.callon;
                        var callat = info.callat;
                        var bd09 = wgs84tobd09(callon, callat)
                        var lng = bd09[0].toFixed(5);
                        var lat = bd09[1].toFixed(5);
                        var address = LocalCacheMgr.getAddress(lng, lat);
                        if (address !== null) {
                            return address;
                        }
                        utils.getBaiduAddressFromBaidu(lng, lat, function (resp) {

                            if (resp.length) {
                                address = resp;
                                $("p.last-address").html(" 详细地址: " + address);
                                LocalCacheMgr.setAddress(lng, lat, address);
                            } else {
                                utils.getJiuHuAddressSyn(callon, callat, function (resp) {
                                    address = resp.address
                                    $("p.last-address").html(" 详细地址: " + address);
                                    LocalCacheMgr.setAddress(lng, lat, address);
                                });
                            }

                        });
                        return "地址正在解析..."
                    },
                    resetMapState: function () {
                        if (this.carMarker) {
                            this.carMarker = null;
                        };
                        if (this.markers.length) {
                            this.markers = [];
                            this.firstMarker = null;
                            this.lastMakrker = null;
                        };

                        if (this.polyline) {
                            this.polyline = null;
                        };
                        if (this.markerLabel) {
                            this.markerLabel = null;
                        };
                        if (this.intervalInstanse) {
                            clearInterval(this.intervalInstanse);
                            this.intervalInstanse = null;
                        };
                        this.map.clearOverlays();
                        this.index = 0;
                        // this.records = [];
                        // this.extractRecords = [];    
                        // var centerPoint = this.map.getCenter();
                        // if (this.map.getZoom() != 5 || centerPoint.lng !== 108.0017245 || centerPoint.lat !== 35.926895) {
                        //     this.map.centerAndZoom(new BMap.Point(108.0017245, 35.926895), 5);
                        // };
                    },
                    getDirectionIcon: function (angle) {
                        return new BMap.Icon("images/carstate/green_" + angle + ".gif", new BMap.Size(17, 17), { imageOffset: new BMap.Size(0, 0) });
                    },
                    onShowCtrl:function(){
                        this.isShowCtrl = !this.isShowCtrl;
                    },
                    onShowMarker:function(){
                        this.isShowMarker = !this.isShowMarker;
                    }
                },
                computed: {
                    token: function () {
                        return Cookies.get("token");
                    }
                },
                watch: {
                    startTime: function () {
                        var date = this.startTime;
                        var year = date.getFullYear();
                        var month = date.getMonth() + 1;
                        var day = date.getDate();
                        var dateStr = year + "-" + (month<10?'0'+month:month) + "-" + (day<10?'0'+day:day);
                        this.startTimeStr = dateStr + " 00:00:00";
                        this.endTimeStr = dateStr + " 23:59:00";
                    },
                    velocity: function () {
                        this.action();
                    },
                    isShowMarker:function(){
                        var mkLength = this.markers.length;
                        if(mkLength > 2){
                            var markers = this.markers.slice(1,mkLength - 1);
                       
                            for(var i = 0 ; i < markers.length ; i++ ){
                                var marker = markers[i];
                                if(this.isShowMarker){
                                    this.map.addOverlay(marker);
                                }else{
                                    this.map.removeOverlay(marker);
                                }
                                    
                            };
                            
                        };
                    }
                },
                mounted: function () {
                    this.initMap();
                    var deviceid = utils.getParameterByName("deviceid");
                    this.startTime = new Date();
                    if (deviceid) {
                        this.deviceid = deviceid;
                    } else {
                        this.$Message.error("设备序号不能为空!");
                    };
                }
            });
        })();
    </script>
</body>

</html>