<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>轨迹回放</title>
    <link rel="stylesheet" href="dist/styles/iview.css">
    <style>
        html,body,#container,#bmap{
            width: 100%;
            height: 100%;  
            position: relative;
        }
        div.controller{
            position: absolute;
            left: 0;
            top: 0;
            width: 800px;
            height: 60px;
            line-height: 60px;
            background: #E8F0F7; 
            border-bottom:1px solid #C3CEDE; 
            border-right:1px solid #C3CEDE; 
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="bmap"></div>
        <div class="controller">
            <i-row>
                <i-col :span="4" style="text-align: right">
                    时间跨度为7天 : &nbsp;
                </i-col>
                <i-col :span="20">
                    <date-picker type="datetimerange" :editable="false" :options="dateOptions" v-model="selectDate" placeholder="请选择时间" style="width: 300px"></date-picker>  
                    <i-button @click="sosoTracks">搜索轨迹</i-button>   
                </i-col>
            <i-row>
        </div>
        <Spin size="large" fix v-if="spinShow"></Spin>
    </div>
    <script src="dist/vue.min.js"></script>
    <script src="dist/iview.min.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/js.cookie.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/transformlatlon.js"></script>
    <script src="js/dateformat.js"></script>
    <script src="js/util.js"></script>
    <script src="http://api.map.baidu.com/api?v=3.0&ak=e7SC5rvmn2FsRNE4R1ygg44n"></script>
    <script>
        (function () { 
            var vm = new Vue({
                    el:"#container",
                    data:{
                        map:null,
                        dateOptions:{
                            disabledDate:function(date){
                                if(!date.length){
                                    var  time = date.getTime();
                                    var currentTime = Date.now();
                                    if(time <　currentTime){
                                        return false;
                                    }else{
                                        return true;
                                    }
                                }
                            }
                        },
                        selectDate:null,
                        dayTime:60*60*24*1000,   
                        lock:false,  
                        deviceid: null,
                        startTime: null,
                        endTime : null,
                        len : null ,
                        respCount:0,
                        spinShow:false,
                        records:[],
                    },
                    methods: {
                        initMap : function(){
                            this.map = new BMap.Map("bmap",{minZoom:4,maxZoom:18});
                            this.map.enableScrollWheelZoom();
                            this.map.enableAutoResize();
                            this.map.disableDoubleClickZoom();
                            this.map.centerAndZoom(new BMap.Point(108.0017245,35.926895),5);
                        },
                        getRequestBeginAndEndTimeStr:function(){
                            var requestTimeStrArr = [];
                            var beginTimeStr = DateFormat.longToDateTimeStr(this.startTime,0);
                            var endTimeStr   = DateFormat.longToDateTimeStr(this.endTime,0);
                            
                            if(beginTimeStr.indexOf("00:00:00") != -1){
                                requestTimeStrArr.push({begintime:this.getDayBeginTimeStr(this.startTime),endtime:this.getDayEndTimeStr(this.startTime)});
                            }else{
                                requestTimeStrArr.push({begintime:beginTimeStr,endtime:this.getDayEndTimeStr(this.startTime)});
                            }

                            if(endTimeStr.indexOf("00:00:00") != -1){
                                requestTimeStrArr.push({begintime:this.getDayBeginTimeStr(this.endTime),endtime:this.getDayEndTimeStr(this.endTime)});  
                            }else{
                                requestTimeStrArr.push({begintime:this.getDayBeginTimeStr(this.endTime),endtime:endTimeStr});  
                            }
                            return requestTimeStrArr;
                        },
                        getMiddleDayReqParameter:function(){
                            var beginDateStr = DateFormat.longToDateStr(this.startTime,8);
                            var endDateStr   = DateFormat.longToDateStr(this.endTime,8);
                            var beginDateStrTime =  DateFormat.dateStrToLong(beginDateStr,0) - 3600*1000*8 + this.dayTime;  
                            var endDateStrTime   =  DateFormat.dateStrToLong(endDateStr,0) - 3600*1000*8 - this.dayTime;    
                            if(beginDateStrTime == endDateStrTime){
                                return [{
                                    begintime:this.getDayBeginTimeStr(beginDateStrTime),
                                    endtime:this.getDayEndTimeStr(beginDateStrTime)
                                }];
                            }else{
                                var timeStrList = this.getTimeStrObj(beginDateStrTime,endDateStrTime);
                                return timeStrList;
                            }
                        },
                        getTimeStrObj:function(beginTime,endTime){
                            var timeStrList = [];
                            do{
                                var timeStrObj = {
                                    begintime:this.getDayBeginTimeStr(endTime),
                                    endtime:this.getDayEndTimeStr(endTime)
                                };
                                timeStrList.push(timeStrObj);
                                endTime = endTime - this.dayTime;   
                            }
                            while (endTime>=beginTime);
                            return timeStrList;
                        },
                        getDayBeginTimeStr:function(beginTime){
                            var timeStr = DateFormat.longToDateStr(beginTime,8);
                            var time = DateFormat.dateStrToLong(timeStr,0) - 3600*1000*8;    
                            return  DateFormat.longToDateTimeStr(time,0);
                        },
                        getDayEndTimeStr:function(endTime){
                            var timeStr = DateFormat.longToDateStr(endTime,8);
                            var time = DateFormat.dateStrToLong(timeStr,0) + this.dayTime - 1000 - 3600*1000*8;                               
                            return DateFormat.longToDateTimeStr(time,0);
                        },
                        sosoTracks:function(){   
                            var me = this;
                            if(this.lock){
                                this.map.removeOverlay();
                                me.records = [];
                                me.respCount = 0;
                                var times = this.getRequestBeginAndEndTimeStr();
                                var begintime1 = times[0].begintime;
                                var endtime1   = times[0].endtime;
                                var begintime2 = times[1].begintime;
                                var endtime2   = times[1].endtime;
                                if(begintime1 == begintime2 && endtime1  == endtime2){
                                    me.len = 1;
                                    this.requestTracks(begintime1,endtime1,function (resp) { 
                                            if(resp.status == 0 && resp.records){
                                                resp.records.forEach(function (record) {
                                                    me.records.push(record);
                                                });     
                                            };
                                            me.drawingLine();
                                    });
                                }else{
                                    var beginDateStr = DateFormat.longToDateStr(this.startTime ,8);
                                    var endDateStr =   DateFormat.longToDateStr(this.endTime - this.dayTime ,8);
                                    if(beginDateStr == endDateStr){
                                        me.len = 2;
                                        times.forEach(function (timeObj) { 
                                            me.requestTracks(timeObj.begintime,timeObj.endtime,function (resp) {                       
                                                if(resp.status == 0 && resp.records){
                                                    resp.records.forEach(function (record) {
                                                        me.records.push(record);
                                                    });     
                                                };
                                                me.drawingLine();
                                            });
                                        });
                                    }else{
                                        var middleTimes =  this.getMiddleDayReqParameter();
                                        var newArr = times.concat(middleTimes);
                                        me.len = newArr.length;
                                        newArr.forEach(function (timeObj) { 
                                            me.requestTracks(timeObj.begintime,timeObj.endtime,function (resp) { 
                                                if(resp.status == 0 && resp.records){
                                                    resp.records.forEach(function (record) {
                                                        me.records.push(record);
                                                    });
                                                };
                                                me.drawingLine();
                                            });
                                        });
                                    }
                                    
                                }
                            }else{
                                this.$Message.error("请选择正确的时间!");
                            }   
                        },
                        requestTracks:function(beginTime,endtime,callback){
                            this.spinShow = true;
                            var me = this;
                            var url = myUrls.queryTracks(Cookies.get("token"));
                            var data = {
                                deviceid: this.deviceid,
                                lbs: 1,
                                timeorder: 0,
                                begintime:beginTime,
                                endtime:endtime
                            };
                            utils.sendAjax(url,data,function (resp) { 
                                me.respCount++;
                                callback(resp)
                            });
                        },
                        drawingLine:function(){
                            if(this.respCount == this.len){
                                this.spinShow = false;
                                this.records.sort(function (a,b) { 
                                    return a.arrivedtime - b.arrivedtime;
                                });

                                if(this.records.length){
                                    var records = this.records; 
                                    var firstRecord = records[0];
                                    var lastRecord = records[records.length-1];
                                    var startPoint =  new BMap.Point (firstRecord.callon,firstRecord.callat);
                                    var lastPoint  =  new BMap.Point (lastRecord.callon,lastRecord.callat);
                                    this.map.addOverlay(new BMap.Marker(startPoint));
                                    this.map.addOverlay(new BMap.Marker(lastPoint));
                                    var lines = [];
                                    for(var i = 1 ; i < records.length ; i ++ ){
                                        var item = records[i];
                                        
                                            lines.push(new BMap.Point (item.callon,item.callat));
                                    }
                                    var polyline = new BMap.Polyline(lines, {strokeColor:"red",strokeWeight:3,strokeOpacity:1.5});
                                    this.map.addOverlay(polyline);
                                };
                                console.log(this.records);
                            };
                        }
                    },
                    computed:{
                        token:function(){
                            return Cookies.get("token");
                        }
                    },
                    watch: {
                        selectDate:function(){
                            if(this.selectDate[0]&&this.selectDate[1]){
                                if(this.selectDate[0] && this.selectDate[1]){
                                    this.startTime = this.selectDate[0].getTime();
                                    this.endTime   = this.selectDate[1].getTime();
                                    if(this.startTime == this.endTime){
                                        this.lock = true;
                                    }else{

                                        if((this.endTime - this.startTime) < this.dayTime ){
                                            this.lock = true;
                                        }else{
                                            var day = (this.endTime - this.startTime)/this.dayTime;
                                            if(day > 7){
                                                this.lock = false;
                                                this.$Message.error("时间不能超过七天!");
                                            }else{
                                                this.lock = true;
                                            };
                                        }
                                    };
                                }else{
                                    this.lock = false;
                                }
                            }else{
                                this.lock = false;
                            }                        
                        }
                    },
                    mounted : function() {
                        this.initMap();
                        var deviceid = utils.getParameterByName("deviceid");
                        if(deviceid){
                            this.deviceid = deviceid;
                        }else{
                            window.close();
                        }       
                    }
                });
        })();
    </script>
</body>
</html>