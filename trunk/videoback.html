<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" href="./favicon.ico" />
    <title>视频</title>
    <link rel="stylesheet" href="dist/styles/iview.css">
    <style>
        html,body,#container,.full{
            width: 100%;
            height: 100%;  
            position: relative;
        }
        .col-cls{
            text-align: center;
            line-height: 32px;
        }
        .row-cls{
            margin-bottom: 10px;
        }
        video{
            object-fit: fill;
            width: 100%;
            height: 100%;
        }
        #videoContent > div{
            float: left;
        }

    </style>
    <link href="./videojs/video-js.css" rel="stylesheet">
    <script src="./videojs/video.js"></script>
    <script src="./videojs/videojs-flash.min.js"></script>
</head>
<body>
    <div id="container">
        <Layout style="height:100%;">
            <i-Header>
                <Row style="height: 100%;">   
                    <i-Col span="12" style="height: 100%;color: #ffffff">
                        <h1 style="color:#ffffff">汽车视频平台</h1>
                    </i-Col>
                </Row> 
            </i-Header>
            <Layout>
                <Sider hide-trigger width="300" style="background-color:#ffffff;padding:10px;">
                    <div class="full">
                        <Row class="row-cls">   
                            <i-Col span="6" class="col-cls">
                                通道编号:
                            </i-Col>
                            <i-Col span="18">
                                <i-select v-model="selectType">
                                    <i-option value="1">CH1</i-option>
                                    <i-option value="2">CH2</i-option>
                                    <i-option value="3">CH3</i-option>
                                    <i-option value="4">CH4</i-option>
                                </i-select>     
                            </i-Col>
                        </Row>
                        <Row class="row-cls">   
                            <i-Col span="6" class="col-cls">
                                选择日期:
                            </i-Col>
                            <i-Col span="18">
                                <Date-Picker type="date" placeholder="选择日期" style="width:100%" v-model="date"></Date-Picker>
                            </i-Col>
                        </Row>
                        <Row class="row-cls">   
                            <i-Col span="6" class="col-cls">
                                时间范围:
                            </i-Col>
                            <i-Col span="18">
                                <Time-Picker 
                                    confirm 
                                    type="timerange" 
                                    placement="bottom-end" 
                                    placeholder="选择时间范围"
                                    style="width:100%;"
                                    v-model="timeRange"></Time-Picker> 
                            </i-Col>
                        </Row>
                        <div>
                            <Row>   
                                <i-Col span="6" class="col-cls">存储类型</i-Col>
                            </Row>
                            <div style="padding-left:30px;">
                                <Radio-Group v-model="storageType" vertical>
                                    <Radio label="mainAndBackupStore">
                                        <span>主存储器或灾备存储器</span>   
                                    </Radio>
                                    <Radio label="mainstore">
                                        <span>主存储器</span>
                                    </Radio>
                                    <Radio label="backupstore">
                                        <span>灾备存储器</span>
                                    </Radio>
                                </Radio-Group>
                            </div>
                        </div>
   
                        <div>
                            <Row>   
                                <i-Col span="6" class="col-cls">录像类型</i-Col>
                            </Row>
                            <Row>   
                                <i-Col span="24" style="padding-left:30px;">
                                    <Radio-Group v-model="mediatype">
                                        <Radio label="all">
                                            <span>所有</span>
                                        </Radio>
                                        <Radio label="video">
                                            <span>视频</span>
                                        </Radio>
                                        <Radio label="audio">
                                            <span>音频</span>
                                        </Radio>
                                    </Radio-Group>
                                </i-Col>
                            </Row>
                        </div>
                        <div style="margin-top:30px;">
                            <Row>
                                <i-col span="18" offset="3">
                                    <i-button style="width:100%;" type="primry" @click="queryMedia">搜索</i-button>
                                </i-col>
                            </Row>
                        </div>
                    </div>
                </Sider>
                <i-Content style="padding:10px;height: 100%;">
                    <Layout class="full">       
                        <i-Content style="height: 100%;">
                            <div class="full" id="videoContent" ref="videoContent">
                                <!-- <video id="video" class="video-js" controls poster="" >   -->
                            </div>                             
                        </i-Content>
                        <i-Footer style="height:300px;padding: 0px;">
                            <div style="height:50px;line-height: 50px;">
                                <i-button shape="circle" icon="ios-play"></i-button> 
                                <i-button shape="circle" icon="ios-square"></i-button> 
                                <i-button shape="circle" icon="ios-skip-forward"></i-button>
                                <i-button shape="circle" icon="ios-rewind"></i-button>
                                <i-button shape="circle" icon="ios-fastforward"></i-button>
                            </div>
                            <i-table border 
                                ref="table" 
                                @on-row-dblclick="handleDblclick"
                                :columns="columns" 
                                :data="tableData" 
                                height="250" 
                                :loading="loading"></i-table>
                        </i-Footer>
                    </Layout>                          
                </i-Content>
            </Layout>   
        </Layout>   
    </div>
    <script src="js/polyfill.min.js"></script>
    <script src="dist/vue.min.js"></script>
    <script src="dist/iview.min.js"></script>
    <script src="js/gps51-jquery.js"></script>
    <script src="js/config.js"></script>
    <script src="js/dateformat.js"></script>
    <script src="js/js.cookie.min.js"></script>
    <script src="js/util.js"></script>

    <script>
        var player = null;
        var deviceid = utils.getParameterByName("deviceid");
        var token = utils.getParameterByName("token");

        var vRoot = new Vue({
            el:"#container",
            data:{
                loading:false,
                selectType:'1',
                date:new Date(),
                timeRange:["00-00-00","23-59-59"],
                storageType:'mainAndBackupStore',
                mediatype:'all',
                videotppe:true,
                tableData:[],
                columns:[
                    {
                        title: '通道号',
                        key: 'channel',
                        width:80,
                    },
                    {
                        title: '开始时间',
                        key: 'starttime',
                        render:function(h,params){
                            var fullStartTime = '20' + params.row.starttime;
                            var yy = fullStartTime.slice(0,4);
                                MM = fullStartTime.slice(4,6),
                                dd = fullStartTime.slice(6,8),
                                hh = fullStartTime.slice(8,10),
                                mm = fullStartTime.slice(10,12),
                                ss = fullStartTime.slice(12,14),
                                dateStr = yy+'-'+MM +'-' + dd + ' ' + hh+':'+mm +':' + ss ;

                            return h('span',{},dateStr)
                        }
                    },
                    {
                        title: '结束时间',
                        key: 'endtime',
                        render:function(h,params){
                            var fullStartTime = '20' + params.row.endtime;
                            var yy = fullStartTime.slice(0,4);
                                MM = fullStartTime.slice(4,6),
                                dd = fullStartTime.slice(6,8),
                                hh = fullStartTime.slice(8,10),
                                mm = fullStartTime.slice(10,12),
                                ss = fullStartTime.slice(12,14),
                                dateStr = yy+'-'+MM +'-' + dd + ' ' + hh+':'+mm +':' + ss ;
                            return h('span',{},dateStr)
                        }
                    },
                    {
                        title: '文件大小',
                        key: 'filesize',
                        render:function(h,params){
                            var mSize = (params.row.filesize/1024/1024).toFixed(2);
                            var filesize = "";
                            if(mSize>1024){
                                filesize = mSize/1024 + "G";
                            }else{
                                filesize = mSize + 'M'
                            }
                            return h('span',{},filesize)
                        }
                    },
                    {
                        title: '操作',
                        key: 'action',
                        render:function(h,params){
                            
                            return h('div',{},
                                [
                                    h('Button',{
                                        props:{
                                            shape:"circle",  
                                            icon:"ios-play"   
                                        }
                                    },null)
                                ]
                            )
                        } 
                    }
                ]
            },
            methods: {
                handleDblclick:function(row){
         
                    var url = myUrls.playRecord(), 
                        me = this,
                        data = {
                            deviceid: deviceid,
                            channel:row.channel,
                            starttime: row.starttime ,
                            endtime: row.endtime  
                        };
                    utils.sendAjax(url,data,function (resp) {
             
                        var record = resp.record , status = resp.status ;
                        console.log('data', record);
                        if(status == CMD_SEND_RESULT_UNCONFIRM){
                            me.$Message.error('发送成功，未收到确认'); 
                        }else if(status === CMD_SEND_RESULT_PASSWORD_ERROR){
                            me.$Message.error('密码错误');
                        }else if(status === CMD_SEND_RESULT_OFFLINE_NOT_CACHE){           
                            me.$Message.error("设备离线，未缓存");   
                        }else if(status === CMD_SEND_RESULT_OFFLINE_CACHED){
                            me.$Message.error("设备离线，已缓存");
                        }else if(status === CMD_SEND_RESULT_MODIFY_DEFAULT_PASSWORD){
                            me.$Message.error("需要修改默认密码");
                        }else if(status === CMD_SEND_RESULT_DETAIL_ERROR){
                            me.$Message.error("错误:" + resp.cause);
                        }else if(status === CMD_SEND_CONFIRMED){
                            console.log('CMD_SEND_CONFIRMED', 6);
                            player.dispose();
                            me.initVideo(record.playurl);
                            player.play();
                        }else if(status === CMD_SEND_OVER_RETRY_TIMES){
                            me.$Message.error("尝试发送3次失败");
                        }else if(status === CMD_SEND_SYNC_TIMEOUT){
                            me.$Message.error("发送超时");
                        }
                    });
                },
                queryMedia:function(){
                    if(!(this.date&&this.timeRange[0]&&this.timeRange[1])){
                        this.$Message.error("请选择时间");
                        return;
                    };
                    var storetype = '';
                    if(this.storageType=='mainAndBackupStore'){
                        storetype = 0;
                    }else if(this.storageType=='mainstore'){
                        storetype = 1;
                    }else if(this.storageType=='backupstore'){
                        storetype = 2;
                    }

                    var mediatype = '';
                    if(this.mediatype=='all'){
                        mediatype = 0;
                    }else if(this.mediatype=='audio'){
                        mediatype = 1;
                    }else if(this.mediatype=='video'){
                        mediatype = 2;
                    }


                    var url = myUrls.queryMediaList(),
                        that = this,
                        dateStr = DateFormat.format(this.date,'yyyy-MM-dd').substr(2),
                        data = {
                            deviceid:deviceid,
                            channel:Number(this.selectType),                //需要查询的通道号
                            starttime:(dateStr + '-' + this.timeRange[0].split(":").join("-")).split("-").join(""),              //开始时间YY-MM-DD-HH-MM-SS
                            endtime:(dateStr + '-' + this.timeRange[1].split(":").join("-")).split("-").join(""),              //结束时间YY-MM-DD-HH-MM-SS
                            mediatype:mediatype,               //资源类型     0：音视频 1音频 2视频 3视频或者音视频
                            storetype:storetype,
                        };
                        that.loading = true;
                    utils.sendAjax(url,data,function (data) {
                        var status = data.status ;
                        var records = data.records;
                        that.loading = false;
                        if(status == CMD_SEND_RESULT_UNCONFIRM){
                            that.$Message.error('发送成功，未收到确认'); 
                        }else if(status === CMD_SEND_RESULT_PASSWORD_ERROR){
                            that.$Message.error('密码错误');
                        }else if(status === CMD_SEND_RESULT_OFFLINE_NOT_CACHE){
                            that.$Message.error("设备离线，未缓存");   
                        }else if(status === CMD_SEND_RESULT_OFFLINE_CACHED){
                            that.$Message.error("设备离线，已缓存");
                        }else if(status === CMD_SEND_RESULT_MODIFY_DEFAULT_PASSWORD){
                            that.$Message.error("需要修改默认密码");
                        }else if(status === CMD_SEND_RESULT_DETAIL_ERROR){
                            that.$Message.error("错误:" + resp.cause);
                        }else if(status === CMD_SEND_CONFIRMED){
                            if(records.length){
                                that.tableData = records;
                            }else{
                                that.$Message.error("没有存储记录");
                            }
                        }else if(status === CMD_SEND_OVER_RETRY_TIMES){
                            that.$Message.error("尝试发送3次失败");
                        }else if(status === CMD_SEND_SYNC_TIMEOUT){
                            that.$Message.error("发送超时");
                        }
                    })
                },
                handleStartVideo:function(){
                    var url = myUrls.startVideos() , me = this;
                    utils.sendAjax(url,{deviceid:deviceid, channels:[1]},function (resp) {
                        me.$Message.success("开始成功")
                    })
                },
                handleStopVideo:function(){
                    var url = myUrls.stopVideos() , me = this;
                    utils.sendAjax(url,{deviceid:deviceid, channels:[1],videoclosetype:0},function (resp) {
                        if(resp.status === 0){
                            me.$Message.success("停止成功")
                        }
                    })
                },
                createVideoElement:function(){
          
                    var videoEl = document.createElement('video');
                        videoEl.setAttribute( 'id' , 'video');
                        videoEl.setAttribute( 'controls' , 'true' );
                        videoEl.setAttribute( 'poster' , '');
                        videoEl.className ="video-js";
                        this.$refs.videoContent.appendChild(videoEl);
                
                },
                initVideo:function(url){
                    this.createVideoElement();
                    var videoContent = this.$refs.videoContent,
                        sources = [{src: 'rtmp://58.200.131.2:1935/livetv/hunantv',type: 'rtmp/flv'}];
                        if(url) sources = [{src: url,type: 'rtmp/flv'}]; 
                    player = videojs('video', {
                        poster:"./images/tv_default.jpg",
                        autoplay: false ,
                        preload:"none",
                        // aspectRatio:'4:3',
                        height:$(videoContent).height(),
                        width:$(videoContent).width(),
                        controlBar: {
                            remainingTimeDisplay:false,
                            progressControl: false,
                            liveDisplay: true,
                        },
                        techOrder: ['html5','flash'],
                        sources: sources,
                    },function(){
                        
                        document.getElementsByClassName('vjs-picture-in-picture-control')[0].style.display = 'none';

                        this.on('play',function () { 
                            document.getElementsByClassName('vjs-big-play-button')[0].style.display = 'none';
    
                        });
                        this.on('pause',function () { 
                            document.getElementsByClassName('vjs-big-play-button')[0].style.display = 'block';

                        });
                    });
                 
                },
                onWindowResize:function(){
                    var videoContent = this.$refs.videoContent;
                    window.onresize = function () { 
                        player.width($(videoContent).width());
                        player.height($(videoContent).height());
                    }
                }
            },
            mounted :function() {
                var that = this; 
                that.$nextTick(function(){ 
                    that.initVideo(); 
                    that.onWindowResize();
                });
            },
        })

        function flashChecker() {
            var hasFlash = 0; //是否安装了flash
            var flashVersion = 0; //flash版本
            if (document.all) {
            var swf = new ActiveXObject('ShockwaveFlash.ShockwaveFlash');
            if (swf) {
                hasFlash = 1;
                VSwf = swf.GetVariable("$version");
                flashVersion = parseInt(VSwf.split(" ")[1].split(",")[0]);
            }
            } else {
            if (navigator.plugins && navigator.plugins.length > 0) {
                var swf = navigator.plugins["Shockwave Flash"];
                if (swf) {
                hasFlash = 1;
                var words = swf.description.split(" ");
                for (var i = 0; i < words.length; ++i) {
                    if (isNaN(parseInt(words[i]))) continue;
                    flashVersion = parseInt(words[i]);
                }
                }
            }
            }
            return { f: hasFlash, v: flashVersion };
        }
        var fls = flashChecker();
        if (!fls.f) {
            vRoot.$Message.error("请安装flash或者允许网页flash播放");
        }
    </script>
</body>
</html>

