<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>保险支付</title>
    <link rel="stylesheet" href="./cube.min.css">
    <style>
        boay {
            font-size: 12px;
            font-family: "微软雅黑";
        }
        
        #app {
            padding-top: 4rem;
        }
        
        #app h1 {
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            padding-bottom: 10px;
        }
        
        #app h4 {
            text-align: center;
            font-size: 16px;
            padding: 10px 0;
            color: red;
        }
        
        #app .cube-input:after {
            border: 1px solid #ccc;
        }
        
        #app .cube-btn {
            background: green;
        }
        
        #app>div {
            padding: 10px 2rem;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1 v-text="goodsname"></h1>
        <h4 v-text="goodsdesc"></h4>
        <h4 v-text="goodspriceStr" style="text-decoration:line-through;color:#e3e3e3;"></h4>
        <h4 v-text="goodsdiscountStr"></h4>
        <div v-text="label"></div>
        <div>
            <cube-input v-model="username" :clearable="true"></cube-input>
        </div>
        <div>
            <cube-button @click="getPrePayInfo" :loading="loading">立即支付</cube-button>
        </div>
    </div>


    <script type="text/javascript" src="../js/gps51-jquery.js"></script>
    <script type="text/javascript" src="./vue.min.js"></script>
    <script type="text/javascript" src="./cube.min.js"></script>
    <script type="text/javascript">
        function getParameterByName(name) {
            var url = location.search;
            url = decodeURIComponent(url);
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = 0; i < strs.length; i++) {
                    theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest[name];
        }


        var openId = getParameterByName("openid");
        var goodsid = getParameterByName("goodsid");
        var goodsname = getParameterByName("goodsname");
        var goodsdesc = getParameterByName("goodsdesc");
        var goodsprice = Number(getParameterByName("goodsprice")).toFixed(2);
        var goodsdiscount = Number(getParameterByName("goodsdiscount")).toFixed(2);

        new Vue({
            el: '#app',
            data: {
                loading: false,
                label: '门店号 :',
                username: 'minigps',
                goodsname: goodsname,
                goodsdesc: goodsdesc,
                goodsprice: goodsprice,
                goodsdiscount: (goodsprice * goodsdiscount).toFixed(2)
            },
            computed: {
                goodspriceStr: function() {
                    return '原价 : ' + this.goodsprice + '元';
                },
                goodsdiscountStr: function() {
                    return '折后 : ' + this.goodsdiscount + '元';
                },
            },
            methods: {
                getPrePayInfo: function() {
                    var state = "wxe44094ffe9730359_insureagent_insureagent20_charge",
                        me = this;
                    if (this.username != "") {
                        // window.location.href = "https://www.gps51.com/wxpay/payaction?openid=" + openId + "&username=" + username + "&goodsid=" + goodsid + "&count=1" + "&state=" + state;
                        // return;
                        //调用支付接口
                        me.loading = true;
                        $.ajax({
                            url: "https://www.gps51.com/wxpay/payaction?openid=" + openId + "&username=" + this.username + "&goodsid=" + goodsid + "&count=1" + "&state=" + state,
                            type: "get",
                            dataType: "json",
                            success: function(json) {
                                var appId = json.appId;
                                var timeStamp = json.timeStamp;
                                var nonceStr = json.nonceStr;
                                var packAge = json.packAge;
                                var signType = json.signType;
                                var paySign = json.paySign;
                                me.onBridgeReady(appId, timeStamp, nonceStr, packAge, signType, paySign);
                            },
                            //调起微信支付失败，恢复到原来的订单量
                            error: function() {
                                me.loading = false;
                                me.$createToast({
                                    txt: '充值失败，请联系客服!',
                                    type: 'txt'
                                }).show();
                            }
                        });
                        //error=0 表示增加订单后总订单数大于10
                    } else {
                        me.$createToast({
                            txt: '请输入门店号!',
                            type: 'txt'
                        }).show();
                    }
                },
                onBridgeReady: function(appId, timeStamp, nonceStr, packAge, signType, paySign) {
                    var me = this;
                    WeixinJSBridge.invoke(
                        'getBrandWCPayRequest', {
                            "appId": appId, //公众号名称，由商户传入     
                            "timeStamp": timeStamp,
                            "nonceStr": nonceStr, //随机串     
                            "package": packAge,
                            "signType": signType, //微信签名方式：     
                            "paySign": paySign //微信签名 
                        },
                        function(res) {
                            me.loading = false;
                            if (res.err_msg == "get_brand_wcpay_request:ok") {
                                // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
                                me.notifyPayOK(nonceStr);
                            }
                        }
                    );
                },
                notifyPayOK: function(nonceStr) {
                    var state = "wxe44094ffe9730359_insureagent_insureagent20_query";
                    //调用通知服务器充值成功
                    var me = this;
                    var toast = this.$createToast({
                        time: 0,
                        txt: '查询中',
                        mask: true,
                    })
                    toast.show();

                    try {
                        $.ajax({
                            url: "https://www.gps51.com/wxpay/payaction?nonestr=" + nonceStr + "&state=" + state,
                            type: "get",
                            dataType: "json",
                            success: function(json) {
                                toast.hide();
                                alert(json.cause);
                                if (json.status == 0) {
                                    var insurecount = json.insurecount;
                                    alert("充值成功，剩余" + insurecount + "份保单");
                                } else {
                                    me.$createToast({
                                        txt: '查询失败',
                                        type: 'txt'
                                    }).show();
                                }
                            },
                            //调起微信支付失败，恢复到原来的订单量
                            error: function(JSON) {
                                toast.hide();
                                me.$createToast({
                                    txt: '查询失败',
                                    type: 'txt'
                                }).show();
                            }
                        });
                    } catch (error) {
                        toast.hide();
                    }
                }
            }
        })
    </script>

</body>

</html>