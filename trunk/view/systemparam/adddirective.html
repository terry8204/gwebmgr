<meta charset="UTF-8">
<div class="pd-10 system" id="add-directive-wraper">
    <h3 class="h3-title">添加指令</h3>
    <div style="width: 700px;margin: 0 auto;">
        
            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">
                    <i style="color: red;display: inline-block;">*</i>&nbsp;设备类型 : &nbsp;</i-col>
                <i-col span="20">
                    <i-select v-model="deviceType">
                        <i-option v-for="item in deviceTypeList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                    </i-select>
                </i-col>  
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">
                    <i style="color: red;display: inline-block;">*</i>&nbsp;指令名称 : &nbsp;</i-col>
                <i-col span="20">
                    <!-- <i-select v-model="cmdCode" filterable>
                        <i-option v-for="item in listCmdAction" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                    </i-select> -->
                    <div class="search-wrapper">
                        <i-input v-model.trim="cmdCodeName"  :icon="iconState" @on-change="sosoValueChange" @on-blur="blur" @on-focus="focus"></i-input>
                        <transition name="fade">
                            <ul class="search-item-wrapper" v-show="isShowMatchDev" style="cursor: pointer;">
                                <li v-for="item in cmdList" style="padding:5px 10px;" @click="selectedCmd(item)">
                                    <Option :value="item.value" :key="item.label">
                                        <span style="cursor: pointer;">{{ item.label }}</span>
                                    </Option>
                                </li>
                            </ul>
                        </transition>
                    </div>
                </i-col>
            </Row>

            <Row style="margin:10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;">*</i>&nbsp;是否同步 : &nbsp;</i-col>
                <i-col span="20" style="height: 100%;line-height:32px;">
                    <Checkbox v-model="isSync">(选中为同步)</Checkbox>
                </i-col>
            </Row>

            
            <Row>
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">指令描述 : &nbsp;</i-col>
                <i-col span="20">
                    <i-input v-model.trim="cmddescr"></i-input>
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">参数类型 : &nbsp;</i-col>
                <i-col span="20">
                    <i-select v-model="selectParamType">
                        <i-option value="text">文本输入</i-option>
                        <i-option value="list">下拉选择</i-option>
                    </i-select> 
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:100%;">
                    参数 : &nbsp;</i-col>
                <i-col span="20">
                    <i-input v-model="params" type="textarea" :rows="8" />
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:100%;">预览 : &nbsp;</i-col>
                <i-col span="20" v-if="selectParamType==='text'">
                    <Row style="margin: 5px 0" v-for="item in previewObjList" :key="item.text">
                        <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">
                            {{item.text}} : &nbsp;
                        </i-col>
                        <i-col span="16">
                            <i-input v-model.trim="kong"></i-input>    
                        </i-col>
                    </Row>
                </i-col>
                <i-col span="20" v-if="selectParamType==='list'">
                    <Row style="margin: 5px 0">
                        <i-col span="16" offset="4">
                            <i-select v-model="preview">
                                <i-option v-for="item in previewObjList" :value="item.type" :key="item.type">{{ item.text }}</i-option>
                            </i-select>
                        </i-col>
                    </Row>
                </i-col>
            </Row>
            <Row style="margin: 10px 0">
                <i-col span="10" :offset="8">
                        <i-button icon="md-add" @click="handleAddDirective" style="width: 100%">添加</i-button>
                </i-col>
            </Row>
            <div style="display:none;">aaa-{{aaa}}</div>
    </div>
    <script>
        new Vue({
            el:"#add-directive-wraper",

            data:function(){
                return {     
                    iconState:"ios-arrow-down",
                    timeoutIns:null,    
                    cmdname: null,
                    cmdnameen: "",
                    cmdnametw: "",

                    cmddescr: null,
                    cmddescren: "",
                    cmddescrtw: "",

                    params: "",
                    paramsen: "",
                    paramstw: "",
                    previewObjList:[],
                    isSync:false,
                    kong:"",
                    deviceType:"",
                    cmdCode:"",
                    cmdCodeName:"",
                    deviceTypeList:[],
                    listCmdAction:[],
                    cmdList:[],
                    isShowMatchDev:false,
                    selectParamType:null,
                    preview:null,
                }
            },
            watch:{
                // params:function () {
                //     this.previewObjList = [];
                //     console.log('params2', this.params)
                //     if(this.replaceAll(this.params) == ""){
                //         var params = "<params>"+ this.params +"</params>";
                //         var parser=new DOMParser(); 
                //         var xmlDoc=parser.parseFromString(params,"text/xml"); 
                //         this.parseXML(xmlDoc);
                //     }
                // }
            },
            computed: {
                aaa:function(){
                    this.previewObjList = [];
                    if(this.checkFormatCorrect(this.params)){
                        var params = "<params>"+ this.params +"</params>";
                        var parser=new DOMParser(); 
                        var xmlDoc=parser.parseFromString(params,"text/xml"); 
                        this.parseXML(xmlDoc);
                    };
                    return this.params+1;
                }
            },
            methods: {
                handleAddDirective:function(){
                    if(!this.deviceType){
                        this.$Message.error("请选择设备类型");
                        return ;
                    }
                    
                    if(!this.cmdCode){
                        this.$Message.error("请选择指令");
                        return ;
                    }
                    var me = this;
                    var url = myUrls.addCmd();
                    var data = {
                        devicetype:this.deviceType,
                        cmdcode:this.cmdCode,    
                        paramsen: "",
                        paramstw: "",
                        cmddescren: "",
                        cmddescrtw: "",
                        cmdnameen: "",
                        cmdnametw: "",
                        sync:this.isSync?1:0
                    };

                    if(this.cmddescr){
                        data.cmddescr = this.cmddescr;
                    };
                    
                    if(this.params){
                        if(this.checkFormatCorrect(this.params.trim())){
                            data.params = this.params;
                        }else{
                            this.$Message.error("参数格式错误");
                            return;
                        }
                    }

                    
                    if(data.params){
                        if(this.selectParamType === 'text'){
                            data.params = "<param type='text'>文本输入</param>\n" + data.params;
                        }else if(this.selectParamType === 'list'){
                            data.params = "<param type='list'>下拉选择 </param>\n" + data.params;
                        }
                    }

                    utils.sendAjax(url, data, function (resp) {
                        if (resp.status == 0) {
                            me.$Message.success("添加成功");
                        }else{
                            me.$Message.error(resp.cause);
                        };
                    });
                },
                checkFormatCorrect:function (str){
                    if(str)
                    str = str.replace(/^<[\s\S]*>[\s\S]*<\/[\s\S]*>$/g,"");
                    return str == "" ? true : false;
                },
                parseXML:function(xmlDoc){
                    // <ha><param size="small" type="password">确认密码</param></ha>
                    var parent =  xmlDoc.children[0];
                    var children = parent.children;
                    for (var i = 0; i < children.length; i++) {
                        var item = children[i]
                        var text = item.innerHTML;
                        var type = item.getAttribute("type");
                        if (type && text) {
                            console.log("{ type: type, text: text }",{ type: type, text: text })
                            this.previewObjList.push({ type: type, text: text });
                        }
                    } 
                },
                getDeviceType:function () {
                    var me = this;
                    var url = myUrls.queryDeviceTypeByUser();
                    utils.sendAjax(url,{},function (resp) { 
                        if(resp.status == 0 && resp.devicetypes!=null){
                            resp.devicetypes.forEach(function (item) { 
                                me.deviceTypeList.push({value:item.devicetypeid,label:item.typename});
                            })
                        }
                    }); 
                },
                getListCmdAction:function(){
                    var me = this;
                    var url = myUrls.listCmdAction();
                    utils.sendAjax(url,{},function (resp) { 
                        if(resp.status == 0){
                            resp.cmds.forEach(function (item) { 
                                var cmdName = item.cmdName;
                                var firstLetter = __pinyin.getFirstLetter(cmdName);
                                var pinyin = __pinyin.getPinyin(cmdName);
                                me.listCmdAction.push({
                                    value:item.cmdCode,
                                    label:cmdName,
                                    firstLetter:firstLetter,
                                    pinyin:pinyin
                                });
                            });
                            me.cmdList = me.listCmdAction;
                        }
                    });  
                },
                sosoValueChange:function(){
                    var me = this;
                    var value = this.cmdCodeName;

                    if (this.timeoutIns != null) {
                        clearTimeout(this.timeoutIns);
                    }

                    if (!value.trim()) {
                        this.cmdList = this.listCmdAction;
                        return;
                    }

                    this.timeoutIns = setTimeout(function () {
                        me.filterMethod(value);
                    }, 300);
                },
                focus: function () {
                    this.isShowMatchDev = true;
                },
                blur: function () {
                    var me = this
                    setTimeout(function () {
                        me.isShowMatchDev = false;
                    }, 300)
                },
                selectedCmd:function(item){
                    var me = this;
                    setTimeout(function () {
                        me.isShowMatchDev = false;
                        me.cmdCodeName = item.label;
                        me.cmdCode = item.value;
                    }, 300)
                },
                filterMethod:function(value){
                    var list = [];
                    var firstLetter = __pinyin.getFirstLetter(value);
                    var pinyin = __pinyin.getPinyin(value);
                    this.listCmdAction.forEach(function (itme) { 
                        if(
                            itme.label.indexOf(value)!=-1 ||
                            itme.firstLetter.indexOf(firstLetter)!=-1 ||
                            itme.pinyin.indexOf(pinyin)!=-1 
                        ){
                            list.push(itme);
                        }
                    })
                    this.cmdList = list;
                }
            },
            watch:{
                isShowMatchDev:function(){
                    if(!this.isShowMatchDev){
                        this.iconState = "ios-arrow-down";
                    }else{
                        this.iconState = "ios-arrow-up";
                    }
                }
            },
            mounted:function () {
                this.getDeviceType();
                this.getListCmdAction();
            }
        })
    </script>
</div>