<meta charset="UTF-8">

<div id="edituser">
    <div class="full">
        <h3 class="h3-title">{{$t("user.editUser")}} &nbsp; <strong>{{username}}</strong> <span> <i-button style="width: 100%" @click="back">{{$t("bgMgr.back")}}</i-button> </span></h3>
            <Tabs type="card">
                    <tab-pane :label="$t('user.userInfo')">
                        <div>

                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("user.username")}} : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="username" disabled></i-input>
                                </i-col>
                            </Row>
                        
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("user.deadline")}} : &nbsp;</i-col>
                                <i-col span="12">
                                    <date-picker type="date" v-model="overduetime" :options="dateOptions"></date-picker>
                                </i-col>
                            </Row>
                        
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("user.userType")}} : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-select v-model="usertype">
                                        <i-option v-for="item in userTypeList" :value="item.type" :key="item.type">{{ item.name }}</i-option>
                                    </i-select>
                                </i-col>
                            </Row>
                        
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("user.client")}} : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-select v-model="companyid">
                                        <i-option v-for="item in companyList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                                    </i-select>
                                </i-col>
                            </Row>
                        
                            <Row style="margin: 10px 0" v-show="isShowGroup">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">{{$t("user.grouping")}} : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-select v-model="groupids" multiple>
                                        <i-option v-for="item in groupList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                                    </i-select>
                                </i-col>
                            </Row>

                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;电话 : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="phone"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;QQ : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="qq"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;微信 : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="wechat"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;邮箱 : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="email"></i-input>
                                </i-col>
                            </Row>
                            <!-- <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">{{$t("user.simultaneousLogin")}}  : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-select v-model="singleLogin">
                                        <i-option value="0">{{$t("user.allow")}}</i-option>
                                        <i-option value="1">{{$t("user.ban")}}</i-option>
                                    </i-select>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">{{$t("user.phoneLogin")}}  : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-select v-model="phoneLogin">
                                        <i-option value="0">{{$t("user.allow")}}</i-option>
                                        <i-option value="1">{{$t("user.ban")}}</i-option>
                                    </i-select>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">{{$t("user.wxLogin")}} : &nbsp;</i-col>
                                <i-col span="12">
                                    <i-select v-model="weixinLogin">
                                        <i-option value="0">{{$t("user.allow")}}</i-option>
                                        <i-option value="1">{{$t("user.ban")}}</i-option>
                                    </i-select>
                                </i-col>
                            </Row> -->
                            <Row style="margin: 10px 0">
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">全部权限 : &nbsp;</i-col>
                                <i-col span="12" style="height: 100%;line-height:32px;">
                                    <Checkbox v-model="allrights"></Checkbox>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0" v-show="!isShowGroup">
                                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("user.groupCount")}} : &nbsp;</i-col>
                                <i-col span="3">
                                    <input-number :max="20" :min="1" v-model="groupcount"></input-number>
                                </i-col>
                        
                                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("group.userCount")}} : &nbsp;</i-col>
                                <i-col span="3">
                                    <input-number :max="100" :min="10" v-model="usercount"></input-number>
                                </i-col>
                        
                                <i-col span="5" style="height: 100%;text-align:right;line-height:32px;">
                                    <i style="color: red;display: inline-block;">*</i>&nbsp;{{$t("group.devCount")}} : &nbsp;</i-col>
                                <i-col span="3">
                                    <input-number :max="500" :min="10" v-model="devicecount"></input-number>
                                </i-col>
                            </Row>
                        
                        
                            <Row style="margin: 10px 0">
                                <i-col span="12" :offset="4">
                                    <i-button style="width:100%" @click="handleSubmit">{{$t("bgMgr.submit")}}</i-button>
                                </i-col>
                            </Row>
                        </div>
                        
                    </tab-pane>
                    <tab-pane :label="$t('user.userAuthority')" :disabled="isDisabled">
                        <div style="width: 100%;height: 400px">
                            <div style="width: 250px;height: 400px;float: left;border: 1px solid #DCDEE2;overflow-y: auto;">
                                <Tree :data="treeData" show-checkbox @on-select-change="handleClickChildren"></Tree> 
                            </div>
                            <div style="width: 440px;height: 400px;float: right;border: 1px solid #DCDEE2">
                                <div style="margin-top:50px">
                                    <Row style="margin: 10px 0">
                                        <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                                &nbsp;{{$t("user.devType")}}&nbsp;:&nbsp;
                                        </i-col>
                                        <i-col span="12" style="height: 100%;line-height:32px;">
                                                &nbsp;{{editTypeName}}
                                        </i-col>
                                    </Row>
                                    <Row style="margin: 10px 0">
                                        <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                                &nbsp;{{$t("user.cmdName")}}&nbsp;:&nbsp;
                                        </i-col>
                                        <i-col span="12" style="height: 100%;line-height:32px;">
                                                &nbsp;{{editDirectiveName}}
                                        </i-col>
                                    </Row>
                                    <Row style="margin: 10px 0" v-show="!isEditDirectivePwd">
                                        <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                                &nbsp;{{$t("user.cmdPwd")}}&nbsp;:&nbsp;
                                        </i-col>
                                        <i-col span="12">
                                            <i-input v-model.trim="directivepwd"></i-input>
                                        </i-col>
                                    </Row>
                                    <Row style="margin: 10px 0" v-show="!isEditDirectivePwd">
                                        <i-col span="8" :offset="8">
                                            <i-button style="width:100%" @click="handleEditDirevtivePwd">{{$t("bgMgr.edit")}}</i-button>
                                        </i-col>
                                    </Row>
                                </div>
                            </div>
                        </div>
                        <Row style="margin: 10px 0">
                            <i-col span="8" :offset="8">
                                <i-button style="width:100%" @click="submitDeviceAuthority">{{$t("user.save")}}</i-button>
                            </i-col>
                        </Row>
                    </tab-pane>
                </Tabs>
        </div>
    </div>

    <script>
        new Vue({
            el:"#edituser",
            i18n: utils.getI18n(),
            data:{
                username:"",
                overduetime:"",
                usertype:"",
                singleLogin:"0",
                phoneLogin:"0",
                weixinLogin:"0",
                companyid:"",
                groupcount:10,
                devicecount:500,
                usercount:10,
                companyList:[],
                groupids:[],
                groupList:[],
                userTypeList:[],
                allrights:false,
                dateOptions: {
                    disabledDate:function(date) {
                        return date && date.valueOf() < Date.now() - 86400000;
                    }
                },
                isShowGroup:false,
                isDisabled:false,
                treeData:[
                    {
                        title: vRoot.$t("user.allDev"),
                        expand: true,
                        selected: false,
                        children: []
                    }
                ],
                devicetypes:[],
                directiveList:[], 
                hadDeviceCmd:[],
                directivepwd:"",
                editTypeName:"",
                editDirectiveName:"",
                isEditDirectivePwd:true,
                directiveInfo:{},
                qq:"",
                email:"",
                phone:"",
                wechat:""
            },
            methods: {
                handleClickChildren:function(data){
                    var directiveInfo = data[0];
                    console.log(data);
                    if(directiveInfo){
                        if(directiveInfo.children == undefined){ 
                            this.directiveInfo = directiveInfo;
                            this.directivepwd = directiveInfo.cmdpwd;
                            var devicetype = directiveInfo.devicetype;
                            var cmdcode = directiveInfo.cmdcode;
                            // var isHasDirective = this.isHasDirective(devicetype,cmdcode);
                            this.editTypeName = directiveInfo.typename;
                            this.editDirectiveName = directiveInfo.title;
                            if(directiveInfo.params){
                                this.isEditDirectivePwd = false;
                            }else{
                                this.isEditDirectivePwd = true; 
                            }
                        }
                    }
                },
                isHasDirective:function(devicetype,cmdcode){
                    var result = false;
                    for(var i = 0 ; i < this.hadDeviceCmd.length ; i++){ 
                        var item = this.hadDeviceCmd[i];
                        if(devicetype == item.devicetype && cmdcode == item.cmdcode){
                            result = true;
                        }
                    }
                    return result;
                },
                handleEditDirevtivePwd:function(){
                    if( this.directivepwd.length > 6){ this.$Message.error(this.$t("message.pwdRule")) ;return; };
                    var me = this;
                    var url = myUrls.editUserDeviceCmdPwd();
                    var data = {
                            username: this.username,
                            cmdcode: this.directiveInfo.cmdcode,
                            devicetype:this.directiveInfo.devicetype,
                            cmdpwd: this.directivepwd
                        };

                    utils.sendAjax(url,data,function (resp) { 
                        if(resp.status == 0){
                            me.$Message.success(me.$t("message.changeSucc"));
                            me.directiveInfo.cmdpwd = data.cmdpwd;
                        }else{
                            me.$Message.error(resp.cause);
                        }
                    });    
                },
                queryAllCompanyInfo:function(claaback){
                    var url = myUrls.queryCompanyByCreater();
                    utils.sendAjax(url,{},claaback)
                },
                doQueryAllCompanyInfo:function(resp){
                    var me = this;
                    if(resp.status == 0){
                        resp.records.forEach(function(item){
                            me.companyList.push({
                                label:item.companyname,
                                value:item.companyid
                            })
                        });

                        me.$nextTick(function () { 
                            me.setUserTypeByUser();
                            me.overduetime = editObject.overduetime;
                            me.companyid = editObject.company.companyid;
                        });
                        
                    }
                },
                queryAllgroupsInfo:function(){
                    var url = myUrls.queryGroupByUser();
                    utils.sendAjax(url,{},this.doQueryAllgroupsInfo);
                },
                doQueryAllgroupsInfo:function(resp){
                    var me = this;
                    if(resp.grouplist && resp.status === 0 ){
                        resp.grouplist.forEach(function (group) { 
                            me.groupList.push({
                                label:group.groupname,
                                value:group.groupid
                            })
                        });
                        if(editObject.groups){
                            editObject.groups.forEach(function(item){
                                me.groupids.push(item.groupid);
                            });
                        }  
                    }
                },
                back:function(){
                    var me = this;
                    var pagePath = null
                        if (myUrls.host.indexOf('gpsserver') != -1) {
                            pagePath = myUrls.host + 'view/manager/queryuser.html'
                        } else {
                            pagePath = '../view/manager/queryuser.html'
                        } 
                    this.$Loading.start();
                    $("#mar-view").load( pagePath ,function(){
                        me.$Loading.finish();
                    });
                },
                handleSubmit:function(){
                    var me = this;
                    var url = myUrls.editUser();
                    var userType = this.usertype;
                    if(this.overduetime == ""){
                        this.$Message.error(this.$t("message.plSelectTime"));
                        return;
                    }
                    var data ={
                        username:this.username,
                        overduetime:new Date(this.overduetime).getTime(),
                        usertype:userType,
                        companyid:this.companyid,
                        qq:this.qq,
                        email:this.email,
                        phone:this.phone,
                        wechat:this.phone
                    }; 

                    for(var key in data){
                        if(data.hasOwnProperty(key)){
                            if(data[key] == "" || data[key] == NaN ){
                                this.$Message.error(this.$t("message.fullComplete"));   
                                return;
                            }
                        };
                    };    

                    data.allrights = this.allrights ? 1 : 0;

                    if(this.isShowGroup){
                        data.groupids = this.groupids;
                    }else{
                        data.groupcount = this.groupcount;
                        data.devicecount = this.devicecount;
                        data.usercount = this.usercount;
                    } 

                    utils.sendAjax(url,data,function (resp) {
                        if(resp.status == 0){
                            me.$Message.success(me.$t("message.changeSucc"));
                        }else{
                            me.$Message.error(me.$t("message.changeFail"));
                        }
                    });
                },
                getGroupsList:function(){
                    var me = this; 
                    var url = myUrls.queryCompanyGroup();                        
                    utils.sendAjax(url,{companyid:this.companyid},function (resp) { 
                        me.groupList = [];
                        me.groupids = [];
                        if(resp.status == 0){
                            var companys = resp.companys
                            for(var i = 0 ; i < companys.length ; i++){
                                var item = companys[i];
                                if(item.companyid == me.companyid && item.groups != null){
                                    var groups = item.groups;
                                    groups.forEach(function(group){
                                        me.groupList.push({label:group.groupname,value:group.groupid});
                                    });                                   
                                };
                            };                          
                        }
                    });
                },
                queryAllDeviceCmdByUser:function(){
                    var me = this;
                    var url = myUrls.queryAllDeviceCmdByUser();
 
                    utils.sendAjax(url,{username:this.username},function (resp) {
                        if(resp.status == 0 ){
                            me.directiveList = resp.records;
                            me.queryAllDeviceTypeByUser();
                        };
                    })    
                },
                queryAllDeviceTypeByUser:function(){
                    var me = this;
                    var url = myUrls.queryAllDeviceTypeByUser();
  
                    utils.sendAjax(url,{username:this.username},function (resp) { 
            
                        if(resp.status == 0 ){
                            me.devicetypes = resp.devicetypes; 
                        };
                    })    
                },
                queryHadDeviceCmdByUser:function(){
                    var me = this;
                    var url = myUrls.queryHadDeviceCmdByUser();
                    var children = me.treeData[0].children;
                    utils.sendAjax(url, { username: this.username }, function (resp) {
                        if (resp.status == 0) {
                            var records = resp.records;
                            me.hadDeviceCmd = resp.records;
                            me.hadDeviceCmd.forEach(function (record) {
                                var devicetype = record.devicetype;
                                var cmdcode = record.cmdcode;
                                children.forEach(function (data) {
                                    if (data.devicetype == devicetype) {
                                        data.children.forEach(function (item) {
                                            if (item.cmdcode == cmdcode) {
                                                item.checked = true;
                                            };
                                        })
                                    }
                                });
                            });
                        }
                    });
                },
                submitDeviceAuthority:function(){
                    var me = this;
                    var url = myUrls.editUserDeviceCmd();
                    var data = this.getEditUserDeviceCmdData();
                    console.log('data', data);
                    utils.sendAjax(url,data,function (resp) { 
                        if(resp.status == 0){
                            me.$Message.success(me.$t("message.changeSucc"));
                        }else{
                            me.$Message.error(resp.cause);
                        }
                    });
                },
                getEditUserDeviceCmdData :function(){
                    var data = [];
                    var children = this.treeData[0].children;

                    children.forEach(function (device) { 
                        if(device.children.length){
                            var isPush = false;
                            var itemObj = {
                                devicetype:device.devicetype,
                                cmds:[]
                            };
                            device.children.forEach(function (cmd) { 
                                if(cmd.checked){
                                    var cmdObj = {
                                        cmdcode:cmd.cmdcode
                                    };
                                    itemObj.cmds.push(cmdObj);
                                }
                            });
                            if( itemObj.cmds.length){
                                data.push(itemObj);
                            }
                        };
                    });
                    return {
                        data:data,
                        username: this.username
                    }
                },
                setUserTypeByUser:function(){
                    var userType = vstore.state.userType;
                    var newArray = [
                        { "name": isZh ? "一级管理员" : 'Supervisor', "type": 1 },
                        { "name": isZh ? "二级管理员" : 'Manager', "type": 2 },
                        { "name": isZh ? "普通监控员" : 'Monitor', "type": 20 },
                        { "name": isZh ? "设备" : 'Device', "type": 99 },
                        { "name": isZh ? "体验帐号" : 'Demo', "type": 10 }
                    ];
                    if(userType == 1){
                        newArray.shift();
                    }else if(userType == 2){
                        newArray.shift();
                        newArray.shift();
                    }else if(userType >10){
                        newArray = [];
                    }
                    this.userTypeList = newArray;
                    this.usertype = editObject.usertype;    
                },
                // queryUserTypeByUser:function(){
                //     var me = this
                //     var url = myUrls.queryUserTypeByUser();
                //     utils.sendAjax(url,{},function (resp) { 
                //         if(resp.status == 0){
                //             me.$nextTick(function () { 
                //                 me.userTypeList = resp.records;
                //                 me.usertype = editObject.usertype; 
                //             });
                //         }else{
                //             me.$Message.error("error");
                //         }    
                //     });
                // }
            },
            watch:{
                usertype:function(){
                    if(this.usertype >= 10){
                        this.isShowGroup = true;            
                    }else{
                        this.isShowGroup = false;
                    }
                },
                devicetypes:function(){
                    var devicetypes = this.devicetypes;
                    var directiveList = this.directiveList;
                    var datas = [];
                    
                    devicetypes.forEach(function (type) { 

                        var children = [];
                        var typeObj = {
                            title:type.typename,
                            typecode:type.typecode,
                            devicetype:type.devicetypeid,
                            expand: true,
                            children:children
                        };
                        directiveList.forEach(function (directive) { 
                            if(type.devicetypeid == directive.devicetype){
                                var directiveObj = {
                                    title:directive.cmdname,
                                    checked: false,
                                    cmdcode:directive.cmdcode,
                                    params:directive.params,
                                    typename:type.typename,
                                    devicetype:type.devicetypeid,
                                    cmdpwd: directive.cmdpwd
                                }
                                children.push(directiveObj)
                            }
                        });
                        datas.push(typeObj);
                    })
                    this.treeData[0].children = datas;    
                    this.queryHadDeviceCmdByUser();    
                }   
            },
            mounted:function () {
                var me = this;
                this.queryAllCompanyInfo(this.doQueryAllCompanyInfo);
                this.queryAllgroupsInfo();
                this.username = editObject.username;
                this.qq = editObject.qq;
                this.email = editObject.email;
                this.phone = editObject.phone;
                this.wechat = editObject.wechat;
                this.allrights = editObject.allrights === 0 ? false : true; 
                this.queryAllDeviceCmdByUser();
                console.log('editObject', editObject);
            }
        })
    </script>
</div>