<div id="batchmgr" class="full" style="padding: 10px;">
    <div class="demo-spin-container" v-if="loading">
        <Spin size="large" fix></Spin>
    </div>
    <div class="demo-spin-container" v-if="batchSendCmdLoading">
        <Spin fix>
            <Icon type="ios-loading" size=18 class="demo-spin-icon-load"></Icon>
            <div>{{$t("bgMgr.sending")}}:{{idx}}/{{tableData.length}}</div>
        </Spin>
    </div>
    <div class="full">
        <div style="display: flex;flex-direction: row;height: 30px; line-height: 30px;">
            <div style="padding: 0 10px;width: 320px;">
                {{$t("bgMgr.allAevcieList")}}
            </div>
            <div style="width: 500px;">
                {{$t("bgMgr.selectedDeviceList")}} {{tableData.length}}
                <i-button type="error" size="small" @click="tableData=[]" style="float: right;margin: 3px 20px 0 0;">{{$t("insure.removeAll")}}</i-button>
            </div>
            <div style="flex: 1;padding: 0 10px;">
                {{$t("bgMgr.transferGroupList")}}
            </div>
        </div>
        <div style="display: flex;flex-direction: row;position: absolute;left: 0;right: 0;bottom: 0;top: 40px;">
            <div style="padding: 0 10px;width: 320px;">
                <div style="line-height: 45px;">
                    <i-input v-model.trim="searchDeviceVal" style="width: 100%;" icon="search"></i-input>
                </div>
                <Tree :data="searchDeviceList" show-checkbox :style="streeStyle" @on-check-change="onCheckChange"></Tree>
            </div>
            <div style="padding: 0 10px;width: 500px;">
                <i-table border ref="table" :columns="columns" :data="tableData" :height="taleHeight" highlight-row @on-current-change="onCurrentChange"></i-table>
            </div>
            <div style="padding: 0 10px;flex: 1;">
                <div style="height: 40%;overflow-y: auto;border: 1px solid #DCDEE2;">
                    <Tree :data="treeGroupList" @on-select-change="onSelectChange"></Tree>
                </div>
                <div style="height: 60%;padding: 10px 0px;">
                    <div style="height: 100%;border: 1px solid #DCDEE2;">
                        <div v-if="curruntCmdType=='00H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;标准执行年号 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="modifiedOrder"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;修改单号 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="commandWord"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='01H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;驾驶证号码 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='02H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;当前时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='03H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;当前时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;安装时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;初始里程 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;累积里程 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='04H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;当前时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;脉冲系数 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='05H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;车辆识别代号 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;车辆号码 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;车辆分类 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='06H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;内容 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;状态信号 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='07H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;更新时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;3C认证代码 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;认证产品型号 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;记录仪生产日期 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;产品生产流水号 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <div v-if="curruntCmdType=='08H'||curruntCmdType=='09H'||curruntCmdType=='10H'||curruntCmdType=='11H'||curruntCmdType=='12H'||curruntCmdType=='13H'||curruntCmdType=='14H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;开始时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;结束时间 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;模块数 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                            <i-table border :columns="deviceInfoColumns" height="200" :data="deviceInfoData"></i-table>
                        </div>
                        <div v-if="curruntCmdType=='15H'">
                            <Row style="margin: 10px 0">
                                <i-col span="6" style="height: 100%;text-align:right;line-height:32px;">
                                    &nbsp;初次安装日期 : &nbsp;
                                </i-col>
                                <i-col span="12">
                                    <i-input v-model.trim="recordVersion"></i-input>
                                </i-col>
                            </Row>
                        </div>
                        <Row style="margin: 10px 0">
                            <i-col span="12" :offset="5">
                                <i-button @click="onCollection(1)">采集</i-button>
                                <i-button @click="onRefresh">刷新</i-button>
                                <i-button @click="onCollection(2)">设置</i-button>
                            </i-col>
                        </Row>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    vueInstanse = new Vue({
        el: "#batchmgr",
        i18n: utils.getI18n(),
        data: {
            // 0
            recordVersion: '',
            modifiedOrder: '',
            commandWord: '',
            // 1

            loading: false,
            userType: localStorage.getItem('userType'),
            batchSendCmdLoading: false,
            idx: 0,
            curruntCmdType: '00H',
            expirationDate: new Date(),
            resetpasswordtype: '1',
            deviceType: '',
            deviceTypeList: [],
            deviceid: '',
            searchDeviceVal: '',
            searchDeviceList: [],
            deviceInfoColumns: [],
            deviceInfoData: [],
            treeGroupList: [{
                title: '2012版行车记录仪',
                expand: true,
                children: [{
                    title: '采集记录仪执行标准版本',
                    cmdType: '00H',
                    selected: true,
                }, {
                    title: '采集当前驾驶人信息',
                    cmdType: '01H',
                }, {
                    title: '采集/设置记录仪实时时间',
                    cmdType: '02H',
                }, {
                    title: '采集/设置累计行驶里程',
                    cmdType: '03H',
                }, {
                    title: '采集/设置记录仪脉冲系数',
                    cmdType: '04H',
                }, {
                    title: '采集/设置车辆信息',
                    cmdType: '05H',
                }, {
                    title: '采集/设置记录仪状态信号配置信息',
                    cmdType: '06H',
                }, {
                    title: '采集记录仪唯一性编号',
                    cmdType: '07H',
                }, {
                    title: '采集指定的行驶速度记录',
                    cmdType: '08H',
                }, {
                    title: '采集指定的位置信息记录',
                    cmdType: '09H',
                }, {
                    title: '采集指定的疑点事故记录',
                    cmdType: '10H',
                }, {
                    title: '采集指定的超时驾驶记录',
                    cmdType: '11H',
                }, {
                    title: '采集指定的驾驶人身份记录',
                    cmdType: '12H',
                }, {
                    title: '采集指定的记录仪外部供电记录',
                    cmdType: '13H',
                }, {
                    title: '采集指定的速度状态记录',
                    cmdType: '14H',
                }, {
                    title: '设置初次安装日期',
                    cmdType: '15H',
                }]
            }],
            tableData: [],
            mileageRatio: 100,
            columns: [{
                type: 'index',
                width: 60,
            }, {
                title: vRoot.$t('alarm.devName'),
                key: 'devicename'
            }, {
                title: vRoot.$t('alarm.devNum'),
                key: 'deviceid',
            }, {
                title: vRoot.$t('alarm.action'),
                width: 85,
                render: function(h, params) {
                    return h('Button', {
                        props: {
                            type: 'error',
                            size: 'small'
                        },
                        style: {
                            marginRight: '5px'
                        },
                        on: {
                            click: function(event) {
                                event.stopPropagation();
                                event.preventDefault();
                                vueInstanse.tableData.splice(params.index, 1);
                            }
                        }
                    }, vRoot.$t('insure.remove'))
                }
            }, {
                title: vRoot.$t('bgMgr.result'),
                width: 90,
                render: function(h, params) {
                    var result = '',
                        color = '',
                        resultType = params.row.resultType;
                    switch (resultType) {
                        case 0:
                            color = "#2D8CF0";
                            result = vRoot.$t('device.actionSucc');
                            break;
                        case 1:
                            color = "#E4393C";
                            result = vRoot.$t('device.actionFail');
                            break;
                        case 2:
                            color = "#000";
                            result = vRoot.$t('device.notOperated');
                            break;
                        case 3:
                            color = "red";
                            result = vRoot.$t('device.noDevice');
                            break;
                        case 4:
                            color = "red";
                            result = vRoot.$t('device.passwordError');
                            break;
                        case 5:
                            color = "red";
                            result = vRoot.$t('device.abnormalInstructionIssued');
                            break;
                        case 6:
                            color = "red";
                            result = vRoot.$t('monitor.sendCmdNoCache');
                            break;
                        case 7:
                            color = "red";
                            result = vRoot.$t('monitor.sendCmdAlreadyCache');
                            break;
                        case 8:
                            color = "red";
                            result = vRoot.$t('monitor.changePwdSendCmd');
                            break;
                    }
                    return h('span', {
                        style: {
                            color: color
                        }
                    }, result);
                }
            }],
            selectedGroupId: null,
            selectedGroupName: null,
            selectedUserName: null,
            taleHeight: 100
        },
        methods: {
            onRefresh: function() {
                if (this.curruntRow) {
                    this.onCurrentChange(this.curruntRow)
                }
            },
            onCurrentChange: function(curruntRow) {
                this.curruntRow = curruntRow;
                var me = this;
                var url = myUrls.queryRecorderData();
                var data = {
                    recordercommand: this.getRecorderCommand(),
                    deviceid: curruntRow.deviceid
                }
                console.log(data);
                utils.sendAjax(url, data, function(resp) {
                    if (resp.status == 0) {
                        var recorderData = JSON.parse(resp.recorderdata);
                        me.setRecorderData(recorderData);
                    } else {
                        me.$Message.error('查询失败');
                    }
                });
            },
            getRecorderCommand: function() {
                var cmd = 0x00;
                switch (this.curruntCmdType) {
                    case '00H':
                        cmd = 0x00;
                        break;
                    case '01H':
                        cmd = 0x01;
                        break;
                    case '02H':
                        cmd = 0x02;
                        break;
                    case '03H':
                        cmd = 0x03;
                        break;
                    case '04H':
                        cmd = 0x04;
                        break;
                    case '05H':
                        cmd = 0x05;
                        break;
                    case '06H':
                        cmd = 0x06;
                        break;
                    case '07H':
                        cmd = 0x07;
                        break;
                    case '08H':
                        cmd = 0x08;
                        break;
                    case '09H':
                        cmd = 0x09;
                        break;
                    case '10H':
                        cmd = 0x0A;
                        break;
                    case '11H':
                        cmd = 0x0B;
                        break;
                    case '12H':
                        cmd = 0x0C;
                        break;
                    case '13H':
                        cmd = 0x0D;
                        break;
                    case '14H':
                        cmd = 0x0E;
                        break;
                    case '15H':
                        cmd = 0x0F;
                        break;
                }
                return cmd;
            },
            getRecorderData: function() {
                var data = {};
                return data;
            },
            setRecorderData: function(recorderData) {
                switch (this.curruntCmdType) {
                    case '00H':
                        this.recordVersion = recorderData.recordVersion;
                        this.modifiedOrder = recorderData.modifiedOrder;
                        this.commandWord = recorderData.commandWord;
                        break;
                    case '01H':
                        cmd = 0x01;
                        break;
                    case '02H':
                        cmd = 0x02;
                        break;
                    case '03H':
                        cmd = 0x03;
                        break;
                    case '04H':
                        cmd = 0x04;
                        break;
                    case '05H':
                        cmd = 0x05;
                        break;
                    case '06H':
                        cmd = 0x06;
                        break;
                    case '07H':
                        cmd = 0x07;
                        break;
                    case '08H':
                        cmd = 0x08;
                        break;
                    case '09H':
                        cmd = 0x09;
                        break;
                    case '10H':
                        cmd = 0x0A;
                        break;
                    case '11H':
                        cmd = 0x0B;
                        break;
                    case '12H':
                        cmd = 0x0C;
                        break;
                    case '13H':
                        cmd = 0x0D;
                        break;
                    case '14H':
                        cmd = 0x0E;
                        break;
                    case '15H':
                        cmd = 0x0F;
                        break;
                }
            },
            getCmdTypeData: function(type) {
                var data = {
                    deviceids: [],
                    action: 'recorder',
                    recorderaction: type,
                    recordercommand: this.getRecorderCommand(),
                    // recordercommand: 0x00,
                };
                if (type == 2) {
                    data.recorderdata = this.getRecorderData();
                }
                this.tableData.forEach(function(item) {
                    data.deviceids.push(item.deviceid);
                });
                return data;
            },
            onCollection: function(type) {
                var me = this;
                var data = this.getCmdTypeData(type);
                console.log(data);
                if (data.deviceids.length == 0) {
                    me.$Message.error('请选择设备');
                    return;
                }
                var url = myUrls.batchOperate();
                utils.sendAjax(url, data, function(respData) {
                    console.log(respData);
                    if (respData.status === 0) {
                        if (respData.total == respData.success) {
                            me.$Message.success(vRoot.$t('device.actionSucc'));
                        } else {
                            me.$Message.error(vRoot.$t('message.changeFail') + ' : ' + respData.fail);
                        }
                        me.updatedActionState(respData.errorrecords);
                        me.batchModal = false;
                    } else {
                        me.$Message.error(respData.cause);
                    }
                });
            },
            updatedActionState: function(errorrecords) {
                this.tableData.forEach(function(item) {
                    if (errorrecords.indexOf(item.deviceid) != -1) {
                        item.resultType = 1;
                    } else {
                        item.resultType = 0;
                    }
                })
            },
            onCheckChange: function(selectArr) {
                var me = this;
                var tableData = [];
                selectArr.forEach(function(item) {
                    var deviceid = item.deviceid;
                    if (deviceid && !me.isRepeatAddDevice(deviceid)) {
                        utils.deviceInfos[deviceid].resultType = 2;
                        tableData.push(utils.deviceInfos[deviceid]);
                    }
                })
                this.tableData = this.tableData.concat(tableData);
            },
            onSelectChange: function(arr) {
                var row = arr[0];
                if (!row.children) {
                    this.curruntCmdType = row.cmdType;
                }
            },
            isRepeatAddDevice: function(deviceid) {
                var relsut = false;
                for (var i = 0; i < this.tableData.length; i++) {
                    var item = this.tableData[i];
                    if (item.deviceid == deviceid) {
                        relsut = true;
                        break;
                    }
                }
                return relsut;
            },
            queryDevicesTree: function() {
                this.loading = true;
                var url = myUrls.queryDevicesTree(),
                    me = this;
                var data = {
                    username: userName
                };
                utils.sendAjax(url, data, function(respData) {
                    me.loading = false;
                    if (respData.status === 0) {
                        rootuser = respData.rootuser;
                        me.setTreeDataList(respData.rootuser);
                    }
                });
            },
            setTreeDataList: function(rootuser) {
                this.searchDeviceList = [this.castUsersTreeToDevicesTree(rootuser, true, false)];
                this.treeDeviceList = deepClone(this.searchDeviceList);
                // this.treeGroupList = [this.castUsersTreeToDevicesTree(rootuser, false, true)];
            },
            filtered: function(textStr) {
                function uniq(array) {
                    var temp = [];
                    for (var i = 0; i < array.length; i++) {
                        if (temp.indexOf(array[i]) == -1) {
                            temp.push(array[i]);
                        }
                    }
                    return temp;
                }
                var newArr = [];
                textStr.split("\n").forEach(function(item) {
                    if (item) {
                        newArr.push(item);
                    }
                })
                return uniq(newArr);
            },
            getDeviceListGroups: function(groups, isNeedDevice, username, isNeedRadio) {
                var groupsList = [],
                    me = this;
                if (groups != null) {
                    for (var i = 0; i < groups.length; ++i) {
                        var group = groups[i];
                        var groupObj = {
                            title: group.groupname,
                            groupid: group.groupid,

                        }
                        if (isNeedDevice) {
                            groupObj.render = utils.renderGroup;
                        } else {
                            groupObj.render = function(h, params) {
                                var data = params.data;
                                var children = null;

                                if (isNeedRadio) {
                                    children = [
                                        h('span', [
                                            h('Radio', {
                                                props: {
                                                    value: (me.selectedUserName == username && me.selectedGroupId == data.groupid)
                                                },
                                                style: {
                                                    marginRight: '4px'
                                                }
                                            }),
                                            h('Icon', {
                                                props: {
                                                    type: 'ios-folder-open'
                                                },
                                                style: {
                                                    marginRight: '8px'
                                                }
                                            }),
                                            h('span', data.title)
                                        ])
                                    ]
                                } else {
                                    children = [
                                        h('span', [
                                            h('Icon', {
                                                props: {
                                                    type: 'ios-folder-open'
                                                },
                                                style: {
                                                    marginRight: '8px'
                                                }
                                            }),
                                            h('span', data.title)
                                        ])
                                    ]
                                }

                                return h('span', {
                                    on: {
                                        'click': function() {
                                            me.selectedUserName = username;
                                            me.selectedGroupId = data.groupid;
                                            me.selectedGroupName = data.groupname;
                                        }
                                    },
                                    style: {
                                        cursor: 'pointer',
                                        color: (me.selectedUserName == username && me.selectedGroupId == data.groupid) ? '#2D8CF0' : '#000'
                                    }
                                }, children)
                            };
                        }
                        if (isNeedDevice && group.devices) {
                            groupObj.children = [];
                            group.devices.forEach(function(device) {
                                groupObj.children.push({
                                    deviceid: device.deviceid,
                                    title: device.devicename,
                                    render: utils.renderDev
                                });
                                utils.deviceInfos[device.deviceid] = {
                                    deviceid: device.deviceid,
                                    devicename: device.devicename,
                                    username: username,
                                    groupid: groupObj.groupid,
                                    groupname: groupObj.groupname,
                                }
                            });
                        }
                        groupsList.push(groupObj);
                    }
                }

                if (groupsList.length == 0) {
                    groupsList.push({
                        title: 'Default',
                        groupid: 0,
                        render: function(h, params) {
                            var data = params.data;
                            var children = [];
                            if (isNeedRadio) {
                                children = [
                                    h('span', [
                                        h('Radio', {
                                            props: {
                                                value: (me.selectedUserName == username && me.selectedGroupId == group.groupid)
                                            },
                                            style: {
                                                marginRight: '4px'
                                            }
                                        }),
                                        h('Icon', {
                                            props: {
                                                type: 'ios-folder-open'
                                            },
                                            style: {
                                                marginRight: '8px'
                                            }
                                        }),
                                        h('span', data.title)
                                    ])
                                ]
                            } else {
                                children = [
                                    h('span', [
                                        h('Icon', {
                                            props: {
                                                type: 'ios-folder-open'
                                            },
                                            style: {
                                                marginRight: '8px'
                                            }
                                        }),
                                        h('span', data.title)
                                    ])
                                ]
                            }
                            return h('span', {
                                on: {
                                    'click': function() {
                                        me.selectedUserName = username;
                                        me.selectedGroupId = 0;
                                        me.selectedGroupName = 'Default';
                                    }
                                },
                                style: {
                                    cursor: 'pointer',
                                    color: (me.selectedUserName == username && me.selectedGroupId == 0) ? '#2D8CF0' : '#000'
                                }
                            }, children)
                        }
                    });
                }
                return groupsList;

            },
            doCastUsersTreeToDevicesTree: function(usersTrees, isNeedDevice, isNeedRadio) {

                var devicesTreeRecord = [];
                if (usersTrees != null && usersTrees.length > 0) {
                    for (var i = 0; i < usersTrees.length; ++i) {
                        var usersTree = usersTrees[i];
                        var username = usersTree.username;
                        var subusers = usersTree.subusers;
                        var currentsubDevicesTreeRecord = {
                            render: utils.renderPerson,
                        };
                        currentsubDevicesTreeRecord.title = username;
                        var deviceListGroups = this.getDeviceListGroups(usersTree.groups, isNeedDevice, username, isNeedRadio);
                        if (username != null && subusers != null && subusers.length > 0) {
                            var subDevicesTreeRecord = this.doCastUsersTreeToDevicesTree(subusers, isNeedDevice, isNeedRadio);
                            subDevicesTreeRecord = deviceListGroups.concat(subDevicesTreeRecord);
                            currentsubDevicesTreeRecord.children = subDevicesTreeRecord;

                        } else {
                            currentsubDevicesTreeRecord.children = deviceListGroups;

                        }
                        devicesTreeRecord.push(currentsubDevicesTreeRecord);
                    }
                }
                return devicesTreeRecord;
            },
            castUsersTreeToDevicesTree: function(devicesTreeRecord, isNeedDevice, isNeedRadio) {
                var iViewTree = {
                    render: utils.renderPerson,
                    expand: true,
                };
                if (devicesTreeRecord != null) {
                    var username = devicesTreeRecord.username;
                    var subusers = devicesTreeRecord.subusers;
                    iViewTree.title = username;
                    var deviceListGroups = this.getDeviceListGroups(devicesTreeRecord.groups, isNeedDevice, username, isNeedRadio);
                    if (username != null && subusers != null && subusers.length > 0) {

                        var subDevicesTreeRecord = this.doCastUsersTreeToDevicesTree(subusers, isNeedDevice, isNeedRadio);

                        iViewTree.children = deviceListGroups.concat(subDevicesTreeRecord);

                    } else {
                        iViewTree.children = deviceListGroups;
                    }
                }
                return iViewTree;
            },
            calcTableHeight: function() {
                var wHeight = window.innerHeight;
                this.taleHeight = wHeight - 110;
            },
            getDeviceType: function() {
                var me = this;
                var url = myUrls.queryDeviceTypeByUser();
                utils.sendAjax(url, {}, function(resp) {
                    if (resp.status == 0 && resp.devicetypes != null) {
                        resp.devicetypes.forEach(function(item, index) {
                            if (index === 0) {
                                me.deviceType = item.devicetypeid;
                            }
                            me.deviceTypeList.push({
                                value: item.devicetypeid,
                                label: item.typename
                            });
                        })

                    }
                });
            },
            variableDeepSearch: function(treeDataFilter, searchWord, limitcount) {

                var childTemp = [];
                var that = this;
                for (var i = 0; i < treeDataFilter.length; i++) {
                    var copyItem = null;
                    var item = treeDataFilter[i];
                    if (item != null) {

                        var isFound = false;
                        if (item.title.indexOf(searchWord) != -1 || (item.deviceid && item.deviceid.indexOf(searchWord) != -1)) {
                            copyItem = item;
                            copyItem.expand = false;
                            isFound = true;
                        }
                        if (isFound == false && item.children && item.children.length > 0) {
                            // item.expand = true;
                            // childTemp.push(item);
                            var rs = that.variableDeepSearch(item.children, searchWord, limitcount);
                            if (rs && rs.length > 0) {
                                copyItem = deepClone(item);
                                copyItem.children = rs;
                                copyItem.expand = true;
                                isFound = true;
                            }
                        }

                        if (isFound == true) {
                            limitcount++;
                            childTemp.push(copyItem);
                            if (limitcount > 10) {
                                break;
                            }
                        }
                    }
                }

                return childTemp;
            }
        },
        computed: {
            streeStyle: function() {
                return {
                    'height': (this.taleHeight - 45) + 'px',
                    'overflow-y': 'auto'
                }
            },
            deviceids: function() {
                var deviceids = [];
                this.tableData.forEach(function(item) {
                    deviceids.push(item.deviceid);
                });
                return deviceids;
            }
        },
        watch: {
            searchDeviceVal: function(newVal) {

                if (newVal === '') {
                    this.searchDeviceList = deepClone(this.treeDeviceList);
                } else {
                    var limitcount = 0;
                    this.searchDeviceList = this.variableDeepSearch(deepClone(this.treeDeviceList), newVal, limitcount);
                }

            },
            curruntCmdType: function(newVal) {
                switch (newVal) {
                    case '08H':
                        this.deviceInfoColumns = [{
                            title: '时间',
                            key: '12'
                        }, {
                            title: '速度',
                            key: '12'
                        }, {
                            title: '制动',
                            key: '12'
                        }, {
                            title: '左转向',
                            key: '12'
                        }, {
                            title: '右转向',
                            key: '12'
                        }, {
                            title: '远光',
                            key: '12'
                        }, {
                            title: '近光',
                            key: '12'
                        }, {
                            title: 'D2',
                            key: '12'
                        }, {
                            title: 'D1',
                            key: '12'
                        }, {
                            title: 'D0',
                            key: '12'
                        },];
                        break;
                    case '09H':
                    this.deviceInfoColumns = [{
                            title: '时间',
                            key: '12'
                        }, {
                            title: '速度',
                            key: '12'
                        }, {
                            title: '经度',
                            key: '12'
                        }, {
                            title: '纬度',
                            key: '12'
                        }, {
                            title: '海拔',
                            key: '12'
                        }];
                        break;
                    case '10H':
                    this.deviceInfoColumns = [{
                            title: '时间',
                            key: '12',
                            width:160,
                        }, {
                            title: '速度',
                            key: '12',
                            width:160,
                        }, {
                            title: '经度',
                            key: '12',
                            width:160,
                        }, {
                            title: '纬度',
                            key: '12',
                            width:160,
                        }, {
                            title: '海拔',
                            key: '12',
                            width:160,
                        }, {
                            title: '制动',
                            key: '12',
                            width:160,
                        }, {
                            title: '左转向',
                            key: '12',
                            width:160,
                        }, {
                            title: '右转向',
                            key: '12',
                            width:160,
                        }, {
                            title: '远光',
                            key: '12',
                            width:160,
                        }, {
                            title: '近光',
                            key: '12',
                            width:160,
                        },];
                        break;
                    case '11H':
                    this.deviceInfoColumns = [{
                            title: '驾驶证',
                            key: '12'
                        }, {
                            title: '开始时间',
                            key: '12'
                        }, {
                            title: '结束时间',
                            key: '12'
                        }, {
                            title: '开始经度',
                            key: '12'
                        }, {
                            title: '开始纬度',
                            key: '12'
                        }, {
                            title: '开始海拔',
                            key: '12'
                        }, {
                            title: '结束海拔',
                            key: '12'
                        }];
                        break;
                    case '12H':
                    this.deviceInfoColumns = [{
                            title: '时间',
                            key: '12'
                        }, {
                            title: '事件类型',
                            key: '12'
                        }];
                        break;
                    case '13H':
                    this.deviceInfoColumns = [{
                            title: '时间',
                            key: '12'
                        }, {
                            title: '驾驶证',
                            key: '12'
                        }, {
                            title: '事件类型',
                            key: '12'
                        }];
                        break;
                    case '14H':
                    this.deviceInfoColumns = [{
                            title: '速度状态',
                            key: '12'
                        }, {
                            title: '开始时间',
                            key: '12'
                        }, {
                            title: '结束时间',
                            key: '12'
                        }, {
                            title: '速度',
                            key: '12'
                        }, {
                            title: '参考速度',
                            key: '12'
                        }];
                        break;
                }
            }
        },
        mounted: function() {
            var me = this;
            utils.deviceInfos = {};
            this.curruntRow = null;
            this.calcTableHeight();
            this.treeDeviceList = [];
            window.onresize = function() {
                me.calcTableHeight();
            }
            if (rootuser == null) {
                this.queryDevicesTree();
            } else {
                me.setTreeDataList(rootuser);
            }

            this.getDeviceType();
            this.userName = userName;
        },
    })
</script>