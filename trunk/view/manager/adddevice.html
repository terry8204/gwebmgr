<meta charset="UTF-8">
<div id="adddevice">
    <div class="full">
        <h3 class="h3-title">添加设备</h3>
        <div>
            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;">*</i>&nbsp;设备名称 : &nbsp;</i-col>
                <i-col span="8">
                    <i-input v-model.trim="devicename"></i-input>
                </i-col>
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;"></i>&nbsp;登录密码 : &nbsp;</i-col>
                <i-col span="8">
                    <i-input v-model.trim="loginpwd" placeholder="默认设备序号后四位"></i-input>
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;">*</i>&nbsp;设备序号 : &nbsp;</i-col>
                <i-col span="8">
                        <i-input v-model.trim="deviceid"></i-input>
                </i-col>
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">手机号码 : &nbsp;</i-col>
                <i-col span="8">
                    <i-input v-model.trim.number="simnum"></i-input>
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;">*</i>&nbsp;过期时间 : &nbsp;</i-col>
                <i-col span="8">
                    <date-picker type="date" v-model="overduetime" :options="dateOptions" style="width: 100%"></date-picker>
                </i-col>
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;">*</i>&nbsp;设备类型 : &nbsp;</i-col>
                    <i-col span="8">  
                        <!-- devicetype -->
                        <i-select v-model="devicetype" style="width: 100%">
                            <i-option v-for="item in deviceTypeList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                        </i-select>
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;"><i style="color: red;display: inline-block;">*</i>&nbsp;所属客户 : &nbsp;</i-col>
                <i-col span="8">
                    <i-select v-model="companyid" style="width: 100%">
                        <i-option v-for="item in customersList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                    </i-select>
                </i-col>
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">所属分组 : &nbsp;</i-col>
                <i-col span="8">
                    <i-select v-model="groupid">
                        <i-option v-for="item in groupsList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                    </i-select>
                </i-col>
            </Row>

            <Row style="margin: 10px 0">
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">允许登录 : &nbsp;</i-col>
                <i-col span="8">
                    <i-select v-model="loginenable">
                            <i-option value="0">禁止</i-option>
                            <i-option value="1">允许</i-option>
                    </i-select>
                </i-col> 
                <i-col span="4" style="height: 100%;text-align:right;line-height:32px;">是否使用 : &nbsp;</i-col>
                <i-col span="8">
                    <i-select v-model="deviceenable">
                        <i-option value="0">停用</i-option>
                        <i-option value="1">正常</i-option>                        
                    </i-select>
                </i-col>                  
            </Row>
            <Row style="margin: 10px 0">
                <i-col span="6" :offset="7">
                    <i-button style="width: 100%" @click="handleSubmit">提交</i-button>
                </i-col>
                <i-col span="6" :offset="1">
                    <i-button style="width: 100%" @click="resetInfo">重置</i-button>
                </i-col>
            </Row>
        </div>
    </div>
    <script>
        new Vue({
            el:"#adddevice",
            data:{
                dateOptions:{
                    disabledDate:function(date) {
                        return date && date.valueOf() < Date.now() - 86400000;
                    }
                },
                deviceid:"",
                devicename:"",
                devicetype:"",
                simnum:"",
                overduetime:"",
                loginpwd:"",
                loginenable:"1",
                deviceenable:"1",
                groupsList:[],
                customersList:[],
                deviceTypeList:[],
                groupid:'',
                companyid:'',
                alarmTypeList:[],
                checkboxObj:{},
            },
            methods: {
                handleSubmit:function(){
                    var me = this;
                    var url = myUrls.addDevice();

                    if(this.deviceid.length < 11  || this.deviceid.length > 15 ){ 
                        me.$Message.error("设备序号必须是11-15位之间");
                        return;
                    };

                    if(this.overduetime == "" ||  this.devicename == "" || this.companyid ==""){
                        me.$Message.error("请把数据填写完整");
                        return;
                    };

                    var data = {
                        deviceid:this.deviceid,
                        devicename:this.devicename,
                        devicetype:this.devicetype,
                        overduetime:new Date(this.overduetime).getTime(),
                        loginenable:Number(this.loginenable),
                        deviceenable:Number(this.deviceenable),
                        companyid:this.companyid
                    };       
                    
                    if(this.loginpwd){
                        data.loginpwd = $.md5(this.loginpwd);
                    }else{
                        data.loginpwd = $.md5(this.deviceid.substring(7,11));
                    };

                    if(this.simnum){
                        data.simnum = this.simnum;
                    };

                    if(this.groupid){
                        data.groupid = this.groupid;
                    };
       
                    utils.sendAjax(url,data,function (resp) { 
                        if(resp.status == 0){
                            me.$Message.success("添加成功");
                        }else if(resp.status = -1){
                            if( resp.cause!== null && resp.cause.indexOf("token")!=-1){
                                window.location.href = "index.html";
                            }else{
                                me.$Message.error("添加失败");
                            }
                        };
                    });
                },
                resetInfo:function(){
                    this.deviceid = "";
                    this.devicename = "";
                    this.devicetype = "";
                    this.simnum = "";
                    // this.overduetime = "";
                    this.loginpwd = "";
                    this.loginenable = "1";
                    this.deviceenable = "1";
                    this.groupid = "";
                    this.companyid = "";
                },
                queryAllCompanyInfo:function(claaback){
                    var url = myUrls.queryCompanyByCreater();
                    utils.sendAjax(url,{},claaback)
                },
                doQueryAllCompanyInfo:function(resp){
                    var me = this;
                    if(resp.status == 0){
                        resp.records.forEach(function(item){
                            me.customersList.push({
                                label:item.companyname,
                                value:item.companyid
                            })
                        });
                    }
                },
                getGroupsList:function(){
                    var me = this; 
                    var url = myUrls.queryCompanyGroup();                        
                    utils.sendAjax(url,{companyid:this.companyid},function (resp) { 
                        me.groupList = [];
                        me.groupids = [];
                        if(resp.status == 0){
                            var companys = resp.companys
                            for(var i = 0 ; i < companys.length ; i++){
                                var item = companys[i];
                                if(item.companyid == me.companyid && item.groups != null){
                                    var groups = item.groups;
                                    groups.forEach(function(group){
                                        me.groupsList.push({label:group.groupname,value:group.groupid});
                                    });
                                }
                            }
                        }
                    });
                },
                getDeviceType:function () {
                    var me = this;
                    var url = myUrls.queryDeviceTypeByUser();
                    utils.sendAjax(url,{},function (resp) { 
                        if(resp.status == 0 && resp.devicetypes!=null){
                            resp.devicetypes.forEach(function (item) { 
                                me.deviceTypeList.push({value:item.devicetypeid,label:item.typename});
                            })
                        }else if(resp.status == -1){
                            var cause = resp.cause;
                            if(cause.indexOf("token")!=-1){
                                window.location.href = "index.html";
                            }
                        }
                        me.devicetype = 1;
                    }); 
                },
                queryAlarmDescr:function () { 
                    var me = this;
                    var url = myUrls.queryAlarmDescr();
                    utils.sendAjax(url,{},function (resp) { 
                        if(resp.status == 0){
                            var records = resp.records;
                            records.forEach(function (item,index){ 
                                var idx = parseFloat(index/3) 
                                if(index%3 == 0){
                                    var newArr = [];
                                    newArr.push(item)
                                    me.alarmTypeList.push(newArr);
                                }else{
                                    me.alarmTypeList[me.alarmTypeList.length - 1].push(item);
                                }
                                me.checkboxObj[item.alarmcode] = true;
                            })
                        }
                    });
                }
            },
            watch:{
                companyid:function(){
                    this.groupsList = [];
                    this.groupid = "";
                    this.getGroupsList();  
                }
            },
            mounted:function () {
                this.queryAllCompanyInfo(this.doQueryAllCompanyInfo);
                this.getDeviceType();
                this.queryAlarmDescr();
                this.overduetime = new Date(Date.now() + 365*24*3600*1000) ;
            } 
        })
    </script>
</div>