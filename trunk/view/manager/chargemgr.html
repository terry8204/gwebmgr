<div id="charge-mgr">
    <div style="margin:10px;height: 32px;">
        <input type="file" id="file" style="display: none;" />
        <div style="float: left;position: relative;width: 210px;line-height:32px;">
            <div class="search-wrapper" v-click-outside.capture="onClickOutside">
                <i-input v-model.trim="sosoValue" icon="ios-search-outline" @on-change="sosoValueChange" @on-blur="blur" @on-focus="focus" :readonly="readonly" @on-click="focus" :placeholder="placeholder"></i-input>
                <transition name="fade">
                    <div class="search-item-wrapper" v-show="isShowMatchDev">
                        <Tree :data="treeData" @on-check-change="onCheckedDevice"></Tree>
                    </div>
                </transition>
            </div>
        </div>
        <div style="margin-left:10px;float: left;line-height: 32px;position: relative;width: 90px;">
            <i-select v-model="maturityType">
                <i-option value="0">已过期</i-option>
                <i-option value="1">未过期</i-option>
            </i-select>
        </div>
        <div style="margin-left:10px;float: left;height: 32px;position: relative;">
            <div style="float: left;height: 32px;line-height: 32px;">
                天数:
            </div>
            <div style="float: left;line-height: 32px;position: relative;width: 80px;">
                <input-number v-model.number="dayNumbers" :max="1850" :min="1" style="width: 100%;"></input-number>
            </div>
        </div>
        <div style="margin-left:10px;float: left;line-height: 32px;">
            <Checkbox v-model="isIncludeSub">是否包含下级</Checkbox>
        </div>
        <div style="margin-left:10px;float: left;">
            <i-button :loading="loading" type="info" @click="queryChargeDeviceList">{{$t("reportForm.query")}}</i-button>
        </div>
        <div style="margin-left:10px;float: left;">
            <i-button type="primary" @click="handleChargeModal">充值</i-button>
        </div>
        <div style="margin-left:10px;float: left;">
            <Poptip trigger="click" title="确定要删除吗?" confirm @on-ok="handleDelete">
                <i-button type="error">批量删除</i-button>
            </Poptip>
        </div>
        <div style="float: right;">
            <i-button @click="exportData" type="primary">{{$t("reportForm.exportData")}}</i-button>
        </div>
        <div style="float: right;margin-right:10px;">
            <i-button @click="importTownerInfo" type="info">{{$t("insure.importFile")}}</i-button>
        </div>
    </div>
    <div style="margin:10px;">
        <i-table :columns="columns" border ref="table" :height="tableHeight" :data="tableData" :loading="loading" @on-selection-change="onSelection"></i-table>
    </div>
    <Modal v-model="adminModal" width="400" v-cloak>
        <p slot="header" style="color:#2D8CF0;text-align:center">
            充值操作
        </p>
        <div>
            <Row style="margin: 10px 0">
                <i-col span="6" style="height: 100%;line-height:32px;text-align:center">选中个数:</i-col>
                <i-col span="12" style="height: 100%;line-height:32px;">
                    {{selectionArray.length}}
                </i-col>
            </Row>
            <Row style="margin: 10px 0">
                <i-col span="6" style="height: 100%;line-height:32px;text-align:center">充值类型:</i-col>
                <i-col span="12" style="height: 100%;line-height:32px;">
                    <Radio-Group v-model="type">
                        <Radio label="years"><span>年数</span></Radio>
                        <Radio label="days"><span>日期</span></Radio>
                    </Radio-Group>
                </i-col>
            </Row>
            <Row style="margin: 10px 0" v-show="type=='years'">
                <i-col span="6" style="height: 100%;line-height:32px;text-align:center">添加年数:</i-col>
                <i-col span="17" style="height: 100%;line-height:32px;">
                    <Radio-Group v-model="years">
                        <Radio label="1年"></Radio>
                        <Radio label="2年"></Radio>
                        <Radio label="3年"></Radio>
                        <Radio label="4年"></Radio>
                        <Radio label="5年"></Radio>
                    </Radio-Group>
                </i-col>
            </Row>
            <Row style="margin: 10px 0" v-show="type=='days'">
                <i-col span="6" style="height: 100%;line-height:32px;text-align:center">选择日期:</i-col>
                <i-col span="17" style="height: 100%;line-height:32px;">
                    <date-picker type="date" v-model="overdueDate" style="width: 100%"></date-picker>
                </i-col>
            </Row>
        </div>
        <div slot="footer" style="padding:6.5px 15px;">
            <i-button style="width:100%;" type="primary" @click="handlerChargeDevices">提交</i-button>
        </div>
    </Modal>
    <Modal v-model="modal" width="400" v-cloak>
        <p slot="header" style="color:#2D8CF0;text-align:center">
            充值操作
        </p>
        <div>
            <Row style="margin: 10px 0">
                <i-col span="6" style="height: 100%;line-height:32px;text-align:center">选中个数:</i-col>
                <i-col span="12" style="height: 100%;line-height:32px;">
                    {{selectionArray.length}}
                </i-col>
            </Row>
            <Row style="margin: 10px 0">
                <i-col span="6" style="height: 100%;line-height:32px;text-align:center">添加年数:</i-col>
                <i-col span="17" style="height: 100%;line-height:32px;">
                    <Radio-Group v-model="years">
                        <Radio label="1年"></Radio>
                        <Radio label="2年"></Radio>
                        <Radio label="3年"></Radio>
                        <Radio label="4年"></Radio>
                        <Radio label="5年"></Radio>
                    </Radio-Group>
                </i-col>
            </Row>
        </div>
        <div slot="footer" style="padding:6.5px 15px;">
            <i-button style="width:100%;" type="primary" @click="handlerChargeDevices">提交</i-button>
        </div>
    </Modal>

    <script>
        new Vue({
            el: '#charge-mgr',
            i18n: utils.getI18n(),
            mixins: [treeMixin],
            data: {
                isIncludeSub: false,
                modal: false,
                adminModal: false,
                dayNumbers: 30,
                years: '1年',
                type: 'years',
                overdueDate: DateFormat.addYear(new Date(), 1),
                selectionArray: [],
                createrToUser: userName,
                modal: false,
                columns: [{
                    type: 'selection',
                    width: 60,
                    align: 'center'
                }, {
                    type: 'index',
                    width: 60,
                    align: 'center'
                }, {
                    title: vRoot.$t('bgMgr.creater'),
                    key: 'username'
                }, {
                    title: vRoot.$t('alarm.devNum'),
                    key: 'deviceid'
                }, {
                    title: vRoot.$t('alarm.devName'),
                    key: 'devicename'
                }, {
                    title: vRoot.$t('user.devType'),
                    key: 'devicetype',
                }, {
                    title: vRoot.$t('alarm.overdueTime'),
                    sortable: true,
                    key: 'overduedate'
                }],
                tableHeight: 300,
                tableData: [],
                loading: false,
                maturityType: '0',
            },
            methods: {
                handleChargeModal: function() {
                    if (vRoot.$store.state.userType == 0) {
                        this.adminModal = true;
                    } else {
                        this.modal = true;
                    }
                },
                queryChargeDeviceList: function() {
                    this.loading = true;
                    this.selectionArray = [];
                    var me = this;
                    var url = myUrls.queryChargeDeviceList();
                    var overduedays = this.dayNumbers;
                    if (this.maturityType == '0') {
                        overduedays = -overduedays;
                    };
                    var data = {
                        username: this.createrToUser, // 需要查询的账号
                        isquerysubaccount: this.isIncludeSub, //true 是包含下级账号 false 不包含
                        overduedays: overduedays //负数 代表过期多少天 正数代表还有多少天过期
                    };
                    utils.sendAjax(url, data, function(respData) {
                        me.loading = false;
                        console.log('resp', respData);
                        var deviceTypeMap = vRoot.$store.state.deviceTypes;
                        if (respData.status == 0) {
                            if (respData.devices.length) {
                                var resultArray = [];
                                respData.devices.forEach(function(item, index) {
                                    resultArray.push({
                                        username: item.creater,
                                        deviceid: item.deviceid,
                                        devicename: item.devicename,
                                        devicetype: deviceTypeMap[item.devicetype].typename,
                                        devicetypeid: item.devicetype,
                                        chargestatus: item.chargestatus,
                                        overduedate: DateFormat.longToDateStr(item.overduetime, timeDifference),
                                        overduetime: item.overduetime
                                    });
                                });
                                if (me.maturityType == '0') {
                                    resultArray.sort(function(a, b) {
                                        return b.overduetime - a.overduetime;
                                    });

                                } else {
                                    resultArray.sort(function(a, b) {
                                        return a.overduetime - b.overduetime;
                                    });
                                }

                                me.tableData = resultArray;
                            } else {
                                me.tableData = [];
                                me.$Message.error("没有搜索到内容");
                            }
                        } else {
                            me.$Message.error("没有该用户权限");
                        }
                    }, function() {
                        me.loading = false;
                    });
                },
                handleDelete: function(row) {
                    if (this.selectionArray.length == 0) {
                        this.$Message.error("请选择要删除的设备");
                    } else {

                        var url = myUrls.deleteDevices(),
                            me = this;
                        var deviceids = this.selectionArray.map(function(item) {
                            return item.deviceid
                        });
                        if (deviceids.length >= 100) {
                            this.$Message.error("一次性删除不能超过100个设备");
                            return;
                        }
                        utils.sendAjax(url, {
                            deviceids: deviceids
                        }, function(resp) {
                            if (resp.status == 0) {
                                me.queryChargeDeviceList();
                                me.$Message.success("删除成功");
                            } else {
                                me.$Message.error("删除失败");
                            }
                        });

                    }

                },
                onSelection: function(result) {
                    this.selectionArray = result;
                },
                handlerChargeDevices: function() {
                    if (this.selectionArray.length == 0) {
                        this.$Message.error("请选择要充值的设备");
                        return;
                    };
                    var url = myUrls.chargeDevices(),
                        me = this;
                    var data = {
                        deviceids: [],
                    }

                    if (vRoot.$store.state.userType == 0) {
                        if (this.type == "years") {
                            data.years = parseInt(this.years);
                            data.overduetime = null;
                        } else {
                            data.years = null;
                            data.overduetime = DateFormat.format(this.overdueDate, 'yyyy-MM-dd');
                        }
                    } else {
                        data.years = parseInt(this.years);
                        data.overduetime = null;
                    }

                    this.selectionArray.forEach(function(item) {
                        data.deviceids.push(item.deviceid);
                    });

                    utils.sendAjax(url, data, function(respData) {
                        if (respData.status == 0) {
                            me.modal = false;
                            me.adminModal = false;
                            me.$Message.success("充值成功:" + respData.successcount + "个");
                        } else {
                            me.$Message.error("充值失败");
                        }
                    });
                },
                queryUsersTree: function(callback) {
                    var url = myUrls.queryUsersTree(),
                        me = this;
                    utils.sendAjax(url, {
                        username: userName
                    }, function(respData) {
                        if (respData.status == 0 && respData.rootuser.user) {
                            callback([me.castUsersTreeToDevicesTree(respData.rootuser)]);
                        } else {
                            me.$Message.error(me.$t('monitor.queryFail'))
                        }
                    });
                },
                castUsersTreeToDevicesTree: function(devicesTreeRecord) {
                    var me = this;
                    var iViewTree = {
                        render: function(h, params) {
                            var username = params.data.title;
                            return h('span', {
                                on: {
                                    'click': function() {
                                        me.createrToUser = username;
                                        me.sosoValue = username;
                                    }
                                },
                                style: {
                                    cursor: 'pointer',
                                    color: (me.createrToUser == username) ? '#2D8CF0' : '#000'
                                }
                            }, [
                                h('span', [
                                    h('Radio', {
                                        props: {
                                            value: username == me.createrToUser
                                        },
                                        style: {
                                            marginRight: '4px',
                                            marginLeft: '4px'
                                        }
                                    }),
                                    h('span', params.data.title)
                                ]),
                            ])
                        },
                        expand: true,
                    };
                    if (devicesTreeRecord != null) {
                        var username = devicesTreeRecord.user.username;
                        var subusers = devicesTreeRecord.subusers;
                        iViewTree.title = username;
                        if (username != null && subusers != null && subusers.length > 0) {
                            var subDevicesTreeRecord = this.doCastUsersTreeToDevicesTree(subusers);
                            iViewTree.children = subDevicesTreeRecord;

                        }
                    }
                    return iViewTree;
                },
                doCastUsersTreeToDevicesTree: function(usersTrees) {
                    var devicesTreeRecord = [],
                        me = this;
                    if (usersTrees != null && usersTrees.length > 0) {
                        for (var i = 0; i < usersTrees.length; ++i) {
                            var usersTree = usersTrees[i];
                            var username = usersTree.user.username;
                            var subusers = usersTree.subusers;
                            var currentsubDevicesTreeRecord = {
                                render: function(h, params) {
                                    var username = params.data.title;
                                    return h('span', {
                                        on: {
                                            'click': function() {
                                                me.createrToUser = username;
                                                me.sosoValue = username;
                                            }
                                        },
                                        style: {
                                            cursor: 'pointer',
                                            color: (me.createrToUser == username) ? '#2D8CF0' : '#000'
                                        }
                                    }, [
                                        h('span', [
                                            h('Radio', {
                                                props: {
                                                    value: username == me.createrToUser
                                                },
                                                style: {
                                                    marginRight: '4px',
                                                    marginLeft: '4px'
                                                }
                                            }),
                                            h('span', params.data.title)
                                        ]),
                                    ])
                                },
                            };
                            if (username != null && subusers != null && subusers.length > 0) {
                                var subDevicesTreeRecord = this.doCastUsersTreeToDevicesTree(subusers);
                                currentsubDevicesTreeRecord.children = subDevicesTreeRecord;
                            }
                            currentsubDevicesTreeRecord.title = username;
                            devicesTreeRecord.push(currentsubDevicesTreeRecord);
                        }
                    }
                    return devicesTreeRecord;
                },
                calcTableHeight: function() {
                    var wHeight = window.innerHeight;
                    this.tableHeight = wHeight - 125;
                },
                exportData: function() {
                    var tableData = deepClone(this.tableData);
                    tableData.forEach(function(item) {
                        item.cardid = "\t" + item.cardid;
                        item.usernamephonenum = "\t" + item.usernamephonenum;
                        item.phonenum = "\t" + item.phonenum;
                        item.policyno = "\t" + item.policyno;
                        item.vinno = "\t" + item.vinno;
                    });
                    this.$refs.table.exportCsv({
                        filename: vRoot.$t('reportForm.insureData'),
                        original: false,
                        columns: this.columns,
                        data: tableData
                    });
                },
                importTownerInfo: function() {
                    this.fileEl.files.length = 0;
                    this.fileEl.value = "";
                    this.fileEl.click();
                },
                readWorkbookFromLocalFile: function(file, callback) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var data = e.target.result;
                        var workbook = XLSX.read(data, {
                            type: 'binary'
                        });
                        if (callback) callback(workbook);
                    };
                    reader.readAsBinaryString(file);
                },
                parserExcelData: function(excelData) {
                    try {
                        var indexY = 2;
                        var tableData = [];
                        while (true) {
                            var vinnoKey = this.excelX[1] + indexY; //设备ID
                            var policynoKey = this.excelX[2] + indexY; //防盗号

                            if (excelData[vinnoKey] == undefined) {
                                break;
                            }

                            tableData.push({
                                vinno: excelData[vinnoKey] ? String(excelData[vinnoKey].v).trim() : '',
                                policyno: excelData[policynoKey] ? String(excelData[policynoKey].v).trim() : '',
                                status: -1
                            })

                            indexY++;
                        }
                        this.tableData = tableData;
                    } catch (error) {
                        this.$Message.error(vRoot.$t('insure.importExcelFailTips'));
                    }
                }
            },
            mounted: function() {
                var me = this;
                me.queryUsersTree(function(usersTree) {
                    me.groupslist = usersTree;
                    me.treeData = usersTree;
                });
                this.sosoValue = userName;
                this.calcTableHeight();

                this.fileEl = document.getElementById('file');
                this.fileEl.onchange = function(e) {
                    var idx = e.srcElement.value.lastIndexOf('.');
                    var houzhui = e.srcElement.value.slice(idx);
                    if (houzhui.indexOf('xlsx') == -1) {
                        me.$Message.error(vRoot.$t('insure.importExcelTips'));
                        return;
                    }
                    var file = e.target.files[0]
                    me.readWorkbookFromLocalFile(file, function(workbook) {
                        me.parserExcelData(workbook.Sheets['保单信息'])
                    });
                };

            },
        })
    </script>
</div>