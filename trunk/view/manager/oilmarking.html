<div id="oil-marking" class="full">
    <Row style="padding:10px;height: 55px;">
        <div style="float: left;">
            <div style="height: 35px; line-height: 35px;">{{$t("reportForm.selectDev")}}:&nbsp;</div>
        </div>
        <div style="float: left;position: relative;width: 240px;">
            <div class="search-wrapper" v-click-outside.capture="onClickOutside">
                <i-input v-model.trim="sosoValue" icon="ios-search-outline" @on-change="sosoValueChange" @on-blur="blur" @on-focus="focus" :placeholder="placeholder" @on-click="focus"></i-input>
                <transition name="fade">
                    <ul class="search-item-wrapper" v-show="isShowMatchDev">
                        <li class="demo-auto-complete-item" v-for="item in filterData">
                            <div class="demo-auto-complete-group" v-show="item.devices.length" @click="sosoSelectGroup(item.groupname)">
                                <span>{{ item.groupname }}</span>
                            </div>
                            <div v-for="option in item.devices" :value="option.groupname" :key="option.groupname" class="ivu-select-item">
                                <span :style="{color:option.isOnline ? '#33DAD0':'#B1BBC2'}" @click="sosoSelect(option)" class="demo-auto-complete-title">{{ option.allDeviceIdTitle }}</span>
                            </div>
                        </li>
                    </ul>
                </transition>
            </div>
        </div>
        <div style="margin-left:10px;float: left;">
            <i-button @click="cleanSelectedDev" icon="ios-nuclear-outline">{{$t("reportForm.clean")}}</i-button>
        </div>
        <div style="float: left;padding-left: 10px;">
            <span>{{$t("reportForm.selectTime")}}:</span>
            <date-picker type="date" v-model="date" :editable="false" :clearable="false" @on-change="onChange" show-week-numbers style="width:180px" placement="bottom-start"></date-picker>
        </div>
        <div style="margin-left:10px;float: left;">
            <i-button @click="onClickQuery">{{$t("reportForm.query")}}</i-button>
        </div>
    </Row>
    <div>
        <div id="old-chart" style="width: 100%;height: 180px;"></div>
    </div>
    <div>
        <div id="new-chart" style="width: 100%;height: 180px;"></div>
    </div>
    <div style="padding:10px">
        <Row style="padding: 0px 0px 10px 0px;">
            <i-col span="12">
                <div class="fl">
                    油液:
                </div>
                <div class="fl">
                    <i-select v-model.sync="oilType" style="width: 120px;">
                        <i-option value="1">油液1</i-option>
                        <i-option value="2">油液2</i-option>
                        <i-option value="3">油液3</i-option>
                        <i-option value="4">油液4</i-option>
                    </i-select>
                </div>
                <div class="fl" style="padding-left: 10px;">
                    {{$t("device.threshold")}}:
                </div>
                <div class="fl">
                    <input-number v-if="oilType == '1'" :max="65535" :min="0" v-model.trim.number="threshold1" style="width:120px"></input-number>
                    <input-number v-if="oilType == '2'" :max="65535" :min="0" v-model.trim.number="threshold2" style="width:120px"></input-number>
                    <input-number v-if="oilType == '3'" :max="65535" :min="0" v-model.trim.number="threshold3" style="width:120px"></input-number>
                    <input-number v-if="oilType == '4'" :max="65535" :min="0" v-model.trim.number="threshold4" style="width:120px"></input-number>
                </div>
            </i-col>
            <i-col span="12">
                <div style="padding-left: 10px;">
                    <div class="fl">
                        {{$t("device.scale")}}:
                    </div>
                    <div class="fl">
                        <input-number :max="65535" :min="0" v-model.trim.number="tagging" style="width:70px"></input-number>
                    </div>
                    <div class="fl" style="padding-left: 10px;">
                        {{$t("device.calibratedFluid")}}:
                    </div>
                    <div class="fl">
                        <input-number :max="1500" :min="0" v-model.trim.number="taggingOil" style="width:70px"></input-number>
                    </div>
                    <div class="fl">
                        L
                    </div>
                    <div class="fl" style="margin-left:10px;">
                        <i-button type="primary" @click="addTaggingRow">{{$t("user.add")}}</i-button>
                    </div>
                    <div class="fl" style="margin-left:10px;">
                        <i-button type="primary" @click="preViewOilDetectors">预览</i-button>
                    </div>
                    <div class="fl" style="margin-left:10px;">
                        <i-button type="primary" @click="addTaggingRow">保存</i-button>
                    </div>
                </div>
            </i-col>
        </Row>
        <Row>
            <i-Col span="12">
                <div style="padding: 0px 5px 0px 0px;">
                    <i-table border :columns="taggingColumns" size="small" :data="taggingData" :height="tableHeight"></i-table>
                </div>
            </i-Col>
            <i-Col span="12">
                <div style="padding: 0px 0px 0px 5px;">
                    <i-table border v-if="oilType == '1'" :columns="newTaggingColumns" size="small" :data="newTaggingData1" :height="tableHeight"></i-table>
                    <i-table border v-if="oilType == '2'" :columns="newTaggingColumns" size="small" :data="newTaggingData2" :height="tableHeight"></i-table>
                    <i-table border v-if="oilType == '3'" :columns="newTaggingColumns" size="small" :data="newTaggingData3" :height="tableHeight"></i-table>
                    <i-table border v-if="oilType == '4'" :columns="newTaggingColumns" size="small" :data="newTaggingData4" :height="tableHeight"></i-table>
                </div>
            </i-Col>
        </Row>
    </div>
    <script>
        vueInstanse = new Vue({
            el: '#oil-marking',
            data: {
                groupslist: [],
                date: new Date(),
                tableHeight: 0,
                oilType: '1',
                threshold1: null,
                threshold2: null,
                threshold3: null,
                threshold4: null,
                tagging: 0,
                taggingOil: 0,
                taggingColumns: [{
                    type: 'index',
                    width: 65
                }, {
                    key: 'height',
                    title: vRoot.$t('device.scale'),
                }, {
                    key: 'volume',
                    title: vRoot.$t('reportForm.oil'),
                }, {
                    title: vRoot.$t('alarm.action'),
                    width: 100,
                    render: function(h, params) {
                        var index = params.index;
                        return h('Button', {
                            props: {
                                type: 'info',
                                size: 'small'
                            },
                            on: {
                                click: function() {
                                    var item = vueInstanse.taggingData[index];
                                    if (vueInstanse.oilType == '1') {
                                        vueInstanse.newTaggingData1.push(deepClone(item));
                                    } else if (vueInstanse.oilType == '2') {
                                        vueInstanse.newTaggingData2.push(deepClone(item));
                                    } else if (vueInstanse.oilType == '3') {
                                        vueInstanse.newTaggingData3.push(deepClone(item));
                                    } else if (vueInstanse.oilType == '4') {
                                        vueInstanse.newTaggingData4.push(deepClone(item));
                                    }
                                }
                            }
                        }, isZh ? '复制' : 'Copy')
                    },
                }],
                taggingData: [],
                newTaggingColumns: [{
                    type: 'index',
                    width: 65
                }, {
                    key: 'height',
                    title: vRoot.$t('device.scale'),
                }, {
                    key: 'volume',
                    title: vRoot.$t('reportForm.oil'),
                }, {
                    title: vRoot.$t('alarm.action'),
                    width: 100,
                    render: function(h, params) {
                        var index = params.index;
                        return h('Button', {
                            props: {
                                type: 'error',
                                size: 'small'
                            },
                            on: {
                                click: function() {

                                    if (vueInstanse.oilType == '1') {
                                        vueInstanse.newTaggingData1.splice(index, 1);
                                    } else if (vueInstanse.oilType == '2') {
                                        vueInstanse.newTaggingData2.splice(index, 1);
                                    } else if (vueInstanse.oilType == '3') {
                                        vueInstanse.newTaggingData3.splice(index, 1);
                                    } else if (vueInstanse.oilType == '4') {
                                        vueInstanse.newTaggingData4.splice(index, 1);
                                    }

                                }
                            }
                        }, vRoot.$t('monitor.delete'))
                    },
                }],
                newTaggingData1: [],
                newTaggingData2: [],
                newTaggingData3: [],
                newTaggingData4: [],
            },
            i18n: utils.getI18n(),
            mixins: [reportMixin],
            methods: {
                preViewOilDetectors: function() {
                    var self = this;
                    var url = myUrls.preViewOilDetectors();
                    var startday = DateFormat.longToDateStr(this.date.getTime(), 0);
                    var data = {
                        deviceid: this.queryDeviceId,
                        independent: this.isIndependent ? 0 : 1,
                        startday: startday,
                        endday: startday,
                        oildetectors: [{
                            threshold: this.threshold1,
                            markers: this.newTaggingData1
                        }, {
                            threshold: this.threshold2,
                            markers: this.newTaggingData2
                        }, {
                            threshold: this.threshold3,
                            markers: this.newTaggingData3
                        }, {
                            threshold: this.threshold4,
                            markers: this.newTaggingData4
                        }, ]
                    };
                    utils.sendAjax(url, data, function(resp) {
                        if (resp.status === 0) {
                            self.setChartsOption(self.newChartsIns, resp.records);
                        }
                    });
                },
                addTaggingRow: function() {
                    if (this.oilType == '1') {
                        this.newTaggingData1.push({
                            height: this.tagging,
                            volume: this.taggingOil,
                        })
                    } else if (this.oilType == '2') {
                        this.newTaggingData2.push({
                            height: this.tagging,
                            volume: this.taggingOil,
                        })
                    } else if (this.oilType == '3') {
                        this.newTaggingData3.push({
                            height: this.tagging,
                            volume: this.taggingOil,
                        })
                    } else if (this.oilType == '4') {
                        this.newTaggingData4.push({
                            height: this.tagging,
                            volume: this.taggingOil,
                        })
                    }

                },
                calcTableHeight: function() {
                    var wHeight = window.innerHeight;
                    this.tableHeight = (wHeight - 475 - 62);
                },
                onClickQuery: function() {

                    if (this.queryDeviceId == "") {
                        this.$Message.error(this.$t("reportForm.selectDevTip"));
                        return
                    };
                    var self = this;
                    var startday = DateFormat.longToDateStr(this.date.getTime(), 0);
                    var data = {
                        startday: startday,
                        endday: startday,
                        offset: timeDifference,
                        devices: [this.queryDeviceId],
                    };
                    this.queryOilInfo(this.queryDeviceId);
                    this.loading = true;
                    // recvtime markPointData totalad oil 1 - 4 srcad 0 - 3 devStates devReissue
                    utils.sendAjax(myUrls.reportOilTime(), data, function(resp) {
                        if (resp.status === 0) {
                            self.setChartsOption(self.oldChartsIns, resp.records);
                        }
                    });
                },
                setChartsOption: function(chartsIns, dataList) {

                    var self = this,
                        records = [],
                        totalads = [],
                        recvtime = [],
                        oil1 = [],
                        oil2 = [],
                        oil3 = [],
                        oil4 = [],
                        srcad0 = [],
                        srcad1 = [],
                        srcad2 = [],
                        srcad3 = [],
                        devReissue = [],
                        markPointData = [],
                        altitudes = [],
                        voltages = [],
                        devStates = [];

                    dataList.forEach(function(item, index) {
                        records = item.records;
                        // var independent = item.independent === 0;
                        records.forEach(function(record, index) {
                            var totalad = record.totalad;
                            var ad0 = record.ad0;
                            var ad1 = record.ad1;
                            var ad2 = record.ad2;
                            var ad3 = record.ad3;
                            if (ad0 < 0) {
                                ad0 = 0;
                            };
                            if (ad1 < 0) {
                                ad1 = 0;
                            };
                            if (ad2 < 0) {
                                ad2 = 0;
                            };
                            if (ad3 < 0) {
                                ad3 = 0;
                            };
                            record.totalad = totalad / 100;
                            record.ad0 = ad0 / 100;
                            record.ad1 = ad1 / 100;
                            record.ad2 = ad2 / 100;
                            record.ad3 = ad3 / 100;
                            record.updatetimeStr = DateFormat.longToDateTimeStr(record.updatetime, timeDifference);

                            totalads.push(record.totalad);
                            recvtime.push(record.updatetimeStr);

                            oil1.push(record.ad0);
                            oil2.push(record.ad1);
                            oil3.push(record.ad2);
                            oil4.push(record.ad3);
                            srcad0.push(record.srcad0);
                            srcad1.push(record.srcad1);
                            srcad2.push(record.srcad2);
                            srcad3.push(record.srcad3);
                            if (!isZh) {
                                record.strstatus = record.strstatusen;
                            }
                            devStates.push(record.strstatus);
                            devReissue.push(record.reissue == 0 ? self.$t('header.no') : self.$t('header.yes'));


                        });
                    });

                    // totalads.forEach(function(item, index) {
                    //     if (index != 0) {
                    //         var prevItem = totalads[index - 1];
                    //         var oilDifference = item - prevItem;

                    //         if (Math.abs(oilDifference) > 5) {
                    //             var color = '';
                    //             if (oilDifference > 0) {
                    //                 color = 'green';
                    //             } else {
                    //                 color = 'red';
                    //             }
                    //             markPointData.push({
                    //                 coord: [index, item],
                    //                 value: Math.abs(oilDifference).toFixed(0),
                    //                 itemStyle: {
                    //                     color: color
                    //                 },
                    //                 label: {
                    //                     fontSize: 8,
                    //                 }
                    //             })
                    //         }
                    //     }
                    // })


                    var data = {
                        recvtime: recvtime,
                        markPointData: markPointData,
                        totalad: totalads,
                        oil1: oil1,
                        oil2: oil2,
                        oil3: oil3,
                        oil4: oil4,
                        srcad0: srcad0,
                        srcad1: srcad1,
                        srcad2: srcad2,
                        srcad3: srcad3,
                        devStates: devStates,
                        devReissue: devReissue,
                    };

                    chartsIns.setOption(self.getChartsOption(data));
                },
                getChartsOption: function(dataInfo) {
                    var totoil = vRoot.$t('reportForm.totalOil');
                    var speed = vRoot.$t('reportForm.speed');
                    var dis = vRoot.$t('reportForm.mileage');
                    var time = vRoot.$t('reportForm.time');
                    var usoil1 = vRoot.$t('reportForm.oil1');
                    var usoil2 = vRoot.$t('reportForm.oil2');
                    var usoil3 = vRoot.$t('reportForm.oil3');
                    var usoil4 = vRoot.$t('reportForm.oil4');

                    var srcad0 = vRoot.$t('reportForm.srcad0');
                    var srcad1 = vRoot.$t('reportForm.srcad1');
                    var srcad2 = vRoot.$t('reportForm.srcad2');
                    var srcad3 = vRoot.$t('reportForm.srcad3');

                    var cotgasus = vRoot.$t('reportForm.oil');
                    var status = vRoot.$t('reportForm.status');
                    var reissue = vRoot.$t('reportForm.reissue');

                    var altitude = vRoot.$t('reportForm.altitude');
                    var voltage = vRoot.$t('reportForm.voltage');

                    return {
                        title: {
                            // text: time + '/' + cotgasus,
                            // x: 'center',
                            // textStyle: {
                            //     fontSize: 12,
                            //     fontWeight: 'bolder',
                            //     color: '#333'
                            // }
                        },
                        grid: {
                            top: 30,
                            left: 60,
                            right: 60,
                            bottom: 40,
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(v) {
                                var data = time + ' : ' + v[0].name + '<br/>';
                                for (i in v) {
                                    if (v[i].seriesName && v[i].seriesName != time) {
                                        if (v[i].seriesName == dis) {
                                            var currentDistance = v[i].value;
                                            var totalDistance = ((Number(currentDistance) + firstDistance / 1000)).toFixed(2);
                                            data += v[i].seriesName + ' : ' + currentDistance + "Km(T:" + totalDistance + 'Km)<br/>';

                                        } else if (v[i].seriesName == totoil || v[i].seriesName == usoil1 || v[i].seriesName == usoil2 || v[i].seriesName == usoil3 || v[i].seriesName == usoil4) {
                                            data += v[i].seriesName + ' : ' + v[i].value + 'L<br/>';
                                        } else if (v[i].seriesName == speed) {
                                            data += v[i].seriesName + ' : ' + v[i].value + 'Km/h<br/>';
                                        } else if (v[i].seriesName == altitude) {
                                            data += v[i].seriesName + ' : ' + v[i].value + 'm<br/>';
                                        } else if (v[i].seriesName == voltage) {
                                            data += v[i].seriesName + ' : ' + v[i].value + 'V<br/>';
                                        } else {
                                            data += v[i].seriesName + ' : ' + v[i].value + '<br/>';
                                        }
                                    }
                                }
                                return data;
                            }
                        },
                        legend: {
                            data: [totoil, usoil1, usoil2, usoil3, usoil4, srcad0, srcad1, srcad2, srcad3],
                            selected: this.selectedLegend,
                            // x: 'left',
                            // width: 600,
                        },
                        toolbox: {
                            show: false,
                            feature: {
                                magicType: {
                                    show: true,
                                    type: ['line', 'bar']
                                },
                                restore: {
                                    show: true
                                },
                                saveAsImage: {
                                    show: true
                                }
                            },
                            itemSize: 14
                        },
                        dataZoom: [{
                            show: true,
                            realtime: true,
                            start: 0,
                            end: 100,
                            height: 20,
                            backgroundColor: '#EDEDED',
                            fillerColor: 'rgb(54, 72, 96,0.5)',
                            //fillerColor:'rgb(244,129,38,0.8)',
                            bottom: 0
                        }, {
                            type: "inside",
                            realtime: true,
                            start: 0,
                            end: 100,
                            height: 20,
                            bottom: 0
                        }],
                        xAxis: [{
                            type: 'category',
                            boundaryGap: false,
                            axisLine: {
                                onZero: false
                            },
                            data: dataInfo.recvtime
                        }],
                        yAxis: [{
                            name: totoil, //totoil + '/' + speed
                            type: 'value',
                            nameTextStyle: 10,
                            nameGap: 5,

                        }, ],
                        series: [{
                                smooth: true,
                                name: totoil,
                                type: 'line',
                                symbol: 'none',
                                color: '#C1232B',
                                data: dataInfo.totalad,
                                markPoint: {
                                    data: dataInfo.markPointData,
                                    symbolSize: 36,
                                    symbolKeepAspect: true,
                                }
                            }, {
                                smooth: true,
                                name: usoil1,
                                type: 'line',
                                symbol: 'none',
                                color: '#8E388E',
                                data: dataInfo.oil1
                            },

                            {
                                smooth: true,
                                name: usoil2,
                                type: 'line',
                                symbol: 'none',
                                color: '#FF4500',
                                data: dataInfo.oil2
                            }, {
                                smooth: true,
                                name: usoil3,
                                type: 'line',
                                symbol: 'none',
                                color: '#2177C7',
                                data: dataInfo.oil3
                            }, {
                                smooth: true,
                                name: usoil4,
                                type: 'line',
                                symbol: 'none',
                                color: '#B05432',
                                data: dataInfo.oil4
                            },

                            {
                                smooth: true,
                                name: srcad0,
                                type: 'line',
                                symbol: 'none',
                                color: '#000000',
                                data: dataInfo.srcad0
                            }, {
                                smooth: true,
                                name: srcad1,
                                type: 'line',
                                symbol: 'none',
                                color: '#000000',
                                data: dataInfo.srcad1
                            }, {
                                smooth: true,
                                name: srcad2,
                                type: 'line',
                                symbol: 'none',
                                color: '#000000',
                                data: dataInfo.srcad2
                            }, {
                                smooth: true,
                                name: srcad3,
                                type: 'line',
                                symbol: 'none',
                                color: '#000000',
                                data: dataInfo.srcad3
                            },
                            // {
                            //     smooth: true,
                            //     name: status,
                            //     type: 'line',
                            //     symbol: 'none',
                            //     color: '#000',
                            //     data: dataInfo.devStates
                            // }, {
                            //     smooth: true,
                            //     name: reissue,
                            //     type: 'line',
                            //     symbol: 'none',
                            //     color: '#000',
                            //     data: dataInfo.devReissue
                            // },
                        ]
                    };
                },
                queryOilInfo: function(deviceid) {
                    var url = myUrls.queryOilDetectors(),
                        me = this;
                    utils.sendAjax(url, {
                        deviceid: deviceid
                    }, function(resp) {
                        me.isIndependent = resp.independent == 0 ? true : false;
                        if (resp.oildetectors != null) {
                            me.$Message.success(vRoot.$t('monitor.querySucc'));
                            var oildetectors = resp.oildetectors;
                            me.oildetectors = oildetectors;
                            oildetectors.forEach(function(item, index) {
                                if (index == 0 && me.oilType == '1') {
                                    me.taggingData = item.markers;
                                    me.threshold = item.threshold;
                                } else if (index == 1 && me.oilType == '2') {
                                    me.threshold = item.threshold;
                                    me.taggingData = item.markers;
                                } else if (index == 2 && me.oilType == '3') {
                                    me.threshold = item.threshold;
                                    me.taggingData = item.markers;
                                } else if (index == 3 && me.oilType == '4') {
                                    me.threshold = item.threshold;
                                    me.taggingData = item.markers;
                                }
                            })
                        } else {
                            me.$Message.success(vRoot.$t('device.dataEmptyTips'));
                        }
                    });
                },
            },
            watch: {
                oilType: function(newVal) {
                    var index = 0;
                    var oildetectors = this.oildetectors;
                    var item = null;
                    if (this.oilType == '1') {
                        index = 0;
                    } else if (this.oilType == '2') {
                        index = 1;
                    } else if (this.oilType == '3') {
                        index = 2;
                    } else if (this.oilType == '4') {
                        index = 3;
                    }
                    item = oildetectors[index];
                    if (item) {
                        this.threshold = item.threshold;
                        this.taggingData = item.markers;
                    } else {
                        this.threshold = null;
                        this.taggingData = [];
                    }
                }
            },
            mounted: function() {
                this.groupslist = deepClone(vRoot.$children[1].groups);
                this.oldChartsIns = echarts.init(document.getElementById('old-chart'));
                this.newChartsIns = echarts.init(document.getElementById('new-chart'));

                var data1 = {
                        recvtime: [],
                        markPointData: [],
                        totalad: [],
                        distance: [],
                        veo: [],
                        oil1: [],
                        oil2: [],
                        oil3: [],
                        oil4: [],
                        srcad0: [],
                        srcad1: [],
                        srcad2: [],
                        srcad3: [],
                        devStates: [],
                        devReissue: [],
                        altitudes: [],
                        voltages: []
                    }
                    // recvtime markPointData totalad oil 1 - 4 srcad 0 - 3 devStates devReissue
                var data2 = deepClone(data1);


                if (isZh) {
                    this.selectedLegend = {
                        "油液1(L)": false,
                        "油液2(L)": false,
                        "油液3(L)": false,
                        "油液4(L)": false,
                        "模拟量1": false,
                        "模拟量2": false,
                        "模拟量3": false,
                        "模拟量4": false,
                        "海拔": false,
                        "电压": false,
                    }
                } else {
                    this.selectedLegend = {
                        "Sensor 1(L)": false,
                        "Sensor 2(L)": false,
                        "Sensor 3(L)": false,
                        "Sensor 4(L)": false,
                        "srcad0": false,
                        "srcad1": false,
                        "srcad2": false,
                        "srcad3": false,
                        "Altitude": false,
                        "Voltage": false,
                    }
                }

                var _this = this;
                // setTimeout(function() {
                _this.oldChartsIns.setOption(_this.getChartsOption(data1));
                _this.newChartsIns.setOption(_this.getChartsOption(data2));
                // }, 1000)
                _this.oildetectors = [];
                _this.calcTableHeight();

            }
        })
    </script>
</div>