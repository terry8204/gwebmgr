<meta charset="UTF-8">
<div id="query-company">
    <div class="full">
        <h3 class="h3-title">查询客户</h3>
        <ul>
            <li>
                <i-select v-model="queryType">
                    <i-option v-for="item in queryList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                </i-select> 
            </li>
            <li>
                <i-input v-model.trim="queryParameter"></i-input>
            </li>
            <li>
                <i-button type="primary" @click="handlerClickQuery">查询</i-button>
            </li>
        </ul>

        <div class="table-wraper">
            <i-table border :columns="columns" :data="tableData" :loading="loading"></i-table>
        </div>
        <div class="my-page" style="margin: 5px 0;">
            <Page :total="total" simple :page-size="5" :current="currentIndex" @on-change="changePage"></Page>
        </div>
    </div>
    <script>
vueInstanse = new Vue({
            el:"#query-company",
            data:{
                loading:true,
                    columns: [
                        {
                            title: '公司名称',
                            key: 'companyname',
                        },
                        {
                            title: '企业联系人',
                            key: 'companyperson'
                        },
                        {
                            title: '企业联系电话',
                            key: 'companyphone'
                        },
                        {
                            title: '办公地址',
                            key: 'officeaddr'
                        },
                        {
                            title: '操作',
                            key: 'action',
                            width: 160,
                            render: function(h, params) {
                                return h('div', [
                                    h('Button', {
                                        props: {
                                            type: 'primary',
                                            size: 'small'
                                        },
                                        style: {
                                            marginRight: '5px'
                                        },
                                        on: {
                                            click: function() {
                                                vueInstanse.editCustomer(params.index);
                                            }
                                        }
                                    }, '修改'),
                                    h('Poptip', {
                                        props: {
                                            confirm: true,
                                            title: '确定要删除吗?'
                                        },
                                        on: {
                                            'on-ok': function () {
                                                vueInstanse.del(params.row);
                                            }
                                        }
                                    },[
                                    h('Button', {
                                            props: {
                                            type: 'error',
                                            size: 'small'
                                            }
                                        },"删除") 
                                    ])    
                                ]);
                            }
                        }
                    ],
                    currentIndex:1,
                    tableData: [],
                    queryType:"companyname",
                    queryParameter:"",
                    queryList:[
                        {value:"companyname",label:"公司名称"},
                        {value:"jurdcperson",label:"法人代表"},
                        {value:"companyperson",label:"企业联系人"},
                    ],
                    recordsList:[],
                    total:0,  
                    delCustomerObj:{}
            },
            methods:{
                queryAllCompanyInfo:function(claaback){
                    var url = myUrls.queryCompanyByCreater();
                    utils.sendAjax(url,{},claaback)
                },
                doQueryAllCompanyInfo:function(resp){
                    if(resp.status===0){
                        this.recordsList = resp.records;
                        this.total = this.recordsList.length;
                        this.tableData =  this.recordsList.slice(0,5);
                    }
                    this.loading = false;
                },
                // changePage:function(index){
                //     var offset = index * 5;
                //     var start = (index-1) *5;
                //     this.currentIndex = index;
                //     this.tableData =  this.recordsList.slice(start,offset);
                // },
                editCustomer:function(index){
                    var me = this;
                    editObject = this.tableData[index];   
                    var pagePath = null
                        if (myUrls.host.indexOf('gpsserver') != -1) {
                            pagePath = myUrls.host + 'view/manager/editcustomer.html'
                        } else {
                            pagePath = '../view/manager/editcustomer.html'
                        }                
                    this.$Loading.start();
                    $("#mar-view").load(pagePath,function(){
                        me.$Loading.finish();
                    });
                },

                del:function(delObj){
                   var url = myUrls.deleteCompany();
                   var data = { companyid : delObj.companyid};
                   this.delCustomerObj = delObj;
                   utils.sendAjax(url,data,this.doDeleteCallback);
                },
                doDeleteCallback:function(resp){
                    var me = this; 
                    if(resp.status == 0){
                        this.$Message.success("删除成功");

                        this.recordsList.forEach(function(item,index){
                            if(item.companyid == me.delCustomerObj.companyid){
                                me.$delete(me.recordsList,index);
                            }
                        });

                        this.tableData.forEach(function(item,index){
                            if(item.companyid == me.delCustomerObj.companyid){
                                me.$delete(me.tableData,index);
                            }
                        });
                    }else{
                        this.$Message.error(resp.cause);
                    }
                    this.modal = false;
                },
                // handlerClickQuery(){
                //     var self = this;
                //     var queryTableData = [] ;
                //     this.recordsList.forEach(function (record) { 
                //         var value = record[self.queryType];
                //         if( value && value.indexOf(self.queryParameter)!=-1){
                //             queryTableData.push(record);
                //         }
                //     })
                //     this.tableData = queryTableData;
                // }
            },
            // watch: {
            //     queryParameter:function(){
            //         if(!this.queryParameter){
            //             this.tableData =  this.recordsList.slice(0,5);
            //             this.currentIndex = 1;
            //         }
            //     } 
            // },       
            mixins:[mixIn],
            mounted:function(){
                this.queryAllCompanyInfo(this.doQueryAllCompanyInfo);               
            }
        });
    </script>    
</div>

