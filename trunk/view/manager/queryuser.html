
<meta charset="UTF-8">

<div id="queryuser">
    <div class="full">
        <h3 class="h3-title">{{$t("bgMgr.queryUser")}}</h3>
        <ul>
            <li>
                <i-input v-model.trim="queryParameter"></i-input>
            </li>
            <li>
                <i-button type="primary"  @click="handlerClickQuery">{{$t("reportForm.query")}}</i-button>
            </li>
        </ul>
        <div class="my-total">
            <span>{{$t("bgMgr.userTotal")}} : {{userTotal}}</span>
            <span>{{$t("bgMgr.groupTotal")}} : {{groupTotal}}</span>
            <span>{{$t("bgMgr.deviceTotal")}} : {{deviceTotal}}</span>
        </div>
        <div class="table-wraper">
            <i-table border :columns="columns" height="520" :data="tableData" :loading="loading"></i-table>
        </div>
        <div class="my-page" style="margin: 5px 0;">
            <Page :total="total" simple :page-size="10" :current="currentIndex" @on-change="changePage"></Page>
        </div>

    </div>     
    <script>
 vueInstanse = new Vue({
            el:"#queryuser",
            i18n: utils.getI18n(),
            data:{
                deviceTotal:'',
                userTotal:'',
                groupTotal:'',
                queryParameter:"",
                loading:true,
                total:0,
                currentIndex:1,
                columns: [
                        {
                            title:vRoot.$t("user.client"),
                            key:'companyname'
                        },
                        {
                            title: vRoot.$t("user.username"),
                            key: 'username',
                        },
                        {
                            title: vRoot.$t("user.userType"),
                            key: 'userTypeStr'    
                        },
                        {
                            title:vRoot.$t("user.groupCount"),
                            key:'usedGroupCount'
                        },
                        {
                            title:vRoot.$t("group.userCount"),  
                            key:'usedUserCount'
                        },
                        {
                            title: vRoot.$t("group.devCount"),  
                            key: 'usedDeviceCount' 
                        },
                        {
                            title:vRoot.$t("user.createTime"),
                            key: 'createtime'
                        },
                        {
                            title: vRoot.$t("user.deadline"),
                            key: 'overduetime'
                        },
                        {
                            title: vRoot.$t("bgMgr.action"),
                            key: 'action',
                            width: 250,
                            render: function(h, params) {
                                return h('div', [
                                    h('Button', {
                                        props: {
                                            type: 'primary',
                                            size: 'small'
                                        },
                                        style: {
                                            marginRight: '5px'
                                        },
                                        on: {
                                            click: function() {
                                                vueInstanse.editUser(params.index);
                                            }
                                        }
                                    }, vRoot.$t("bgMgr.edit")),
                                    
                                    h('Poptip', {
                                        props: {
                                            confirm: true,
                                            title: vRoot.$t("message.confirmDel")
                                        },
                                        style: {
                                            marginRight: '5px'
                                        },
                                        on: {
                                            'on-ok': function () {
                                                vueInstanse.handleDelete(params.row.username);
                                            }
                                        }
                                    },[
                                    h('Button', {
                                            props: {
                                            type: 'error',
                                            size: 'small'
                                            }
                                        },vRoot.$t("bgMgr.delete")) 
                                    ])  ,

                                    h('Button', {
                                        props: {
                                            type: 'primary',
                                            size: 'small'
                                        },
                                        style: {
                                            marginRight: '5px'
                                        },
                                        on: {
                                            click: function() {
                                                 vueInstanse.resetDevicePwd(params.index);
                                            }
                                        }
                                    }, vRoot.$t("user.resetPwd"))
                                ]);
                            }
                        }
                    ],
                    tableData: [],
                    recordsList:[],
            },
            methods:{
                handlerClickQuery () {
                    var self = this;
                    var queryTableData = [];
                    var queryParameterLowerCase = this.queryParameter.toLowerCase();
                    if (!self.queryParameter) return;
                    this.recordsList.forEach(function (record) {
                       
                        var username = record.username,
                            companynamePinyin =record.companynamePinyin,
                            companynameFirstLetter = record.companynameFirstLetter ,
                            userTypeStrPinyin = record.userTypeStrPinyin ,
                            userTypeStrFirstLetter = record.userTypeStrFirstLetter ;
    
                        if (
                            record.userTypeStr.indexOf(self.queryParameter) != -1 ||
                            (record.companyname.indexOf(self.queryParameter))  != -1 ||
                            username.toLowerCase().indexOf(queryParameterLowerCase) != -1 || 
                            companynamePinyin.indexOf(queryParameterLowerCase) != -1 ||
                            companynameFirstLetter.indexOf(queryParameterLowerCase) != -1 ||
                            userTypeStrPinyin.indexOf(queryParameterLowerCase) != -1 ||
                            userTypeStrFirstLetter.indexOf(queryParameterLowerCase) != -1 
                        ){        
                            queryTableData.push(record);
                        }
                    })
                    this.tableData = queryTableData;
                },
                getUserInfoList:function(){
                    var url = myUrls.queryUser();
                    utils.sendAjax(url,{username:userName},this.doUserInfoList);
                },
                doUserInfoList:function(resp){
                    if(resp.status == 0 && resp.userlists != null){
                        var me = this;
                        var currdevicecount = 0;
                        var currgroupcount = 0;
                        resp.userlists.forEach(function (item) { 
                            item.usedUserCount = item.company?item.currusercount + "/" + item.usercount :"";
                            item.usedDeviceCount = item.company?item.currdevicecount + "/" + item.devicecount :"";
                            item.usedGroupCount = item.company?item.currgroupcount + "/" + item.groupcount :"";
                            item.companyname = item.company?item.company.companyname:"";
                            currdevicecount += item.company?item.currdevicecount:"";
                            currgroupcount += item.company?item.currgroupcount:"";

                            item.userTypeStr = me.getUserTypeStr(item.usertype);
                            item.createtime = me.timeToDateStr(item.createtime);
                            item.overduetime = me.timeToDateStr(item.overduetime); 

                            item.companynamePinyin = __pinyin.getPinyin(item.company.companyname);
                            item.companynameFirstLetter = __pinyin.getFirstLetter(item.company.companyname);
                            item.userTypeStrPinyin = __pinyin.getPinyin(item.userTypeStr);
                            item.userTypeStrFirstLetter = __pinyin.getFirstLetter(item.userTypeStr);
                        });
                        this.recordsList = resp.userlists;

                        this.tableData = this.recordsList.slice(0,10);
                        this.total = this.recordsList.length;
                        this.deviceTotal = currdevicecount;
                        this.userTotal = resp.userlists.length;
                        this.groupTotal = currgroupcount;
                    }
                    this.loading = false;
                },
                timeToDateStr:function(time){
                    return DateFormat.longToDateTimeStr(time,0);
                },
                getUserTypeStr:function(type){
                    var name = "";
                    for(var i = 0 ; i < this.userTypeDescrList.length ; i++){
                        var item = this.userTypeDescrList[i];
                        if(item.type == type){
                            name = item.name;
                            break;
                        }
                    };
                    return name;
                },
                handleDelete:function(username){
                    var me = this;
                    var url = myUrls.delUser();

                    utils.sendAjax(url,{usernames:[username]},function(resp){
                        if(resp.status == 0){
                            me.$Message.success(me.$t("message.deleteSucc"));
                            me.recordsList.forEach(function(item,index){
                                if(item.username == username){
                                    var delUserItem = me.recordsList[index];
                                    me.deviceTotal -= delUserItem.currdevicecount;
                                    me.userTotal -= 1;
                                    me.groupTotal -= delUserItem.currgroupcount;
                                    me.$delete(me.recordsList,index);
                                }
                            });
                            me.tableData.forEach(function(item,index){
                                if(item.username == username){
                                    me.$delete(me.tableData,index);
                                }
                            });   
                            me.total = me.recordsList.length;
                            me.tableData = me.recordsList.slice( me.currentIndex - 1 , 10);
                        }else{
                            me.$Message.error(resp.cause);
                        }
                        me.modal = false;
                    });     
                },
                editUser:function(index){
                    editObject = this.tableData[index];
                    var me = this;
                    var pagePath = null
                        if (myUrls.host.indexOf('gpsserver') != -1) {
                            pagePath = myUrls.host + 'view/manager/edituser.html' 
                        } else {
                            pagePath = '../view/manager/edituser.html' 
                        }
                    this.$Loading.start();
                    $("#mar-view").load(pagePath,function(){
                        me.$Loading.finish();
                    });
                },
                resetDevicePwd:function(index){
                    var me = this;
                    var username = this.tableData[index].username;
                    var url = myUrls.resetUserLoginPwd();  
                    utils.sendAjax(url,{username:username},function (resp) { 
                        if(resp.status === 0){
                            me.$Message.success(me.$t("message.resetPwdTips"));
                        }else{
                            me.$Message.error("error");
                        }
                    });
                }
            },
            mixins:[mixIn],
            mounted:function(){
                this.userTypeDescrList = vstore.state.userTypeDescrList;
                this.getUserInfoList();
            }
        })
    </script>
</div>        